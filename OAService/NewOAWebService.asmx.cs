using Newtonsoft.Json;
using OAService.MyEntity;
using OAService.MyPublic;
using Oracle.ManagedDataAccess.Client;
using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Linq;
using System.Web;
using System.Web.Script.Serialization;
using System.Web.Services;
using System.Threading;
using System.Data.SqlClient;

namespace OAService
{
    /// <summary>
    /// NewOAWebService 的摘要说明 
    /// </summary> 
    [WebService(Namespace = "http://172.16.11.19:1915/")]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [System.ComponentModel.ToolboxItem(false)]
    // 若要允许使用 ASP.NET AJAX 从脚本中调用此 Web 服务，请取消注释以下行。 
    [System.Web.Script.Services.ScriptService]
    public class NewOAWebService : System.Web.Services.WebService
    {
        /// <summary>
        /// 产品报价单
        /// </summary>type 0-工业 1-实业 2-隆威
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveCPBJ(string time)
        {
            CPBJInfo cpbj = new JavaScriptSerializer().Deserialize<CPBJInfo>(time);
            string oaid = cpbj.oaid;
            string cpmc = cpbj.cpmc;
            string cplx1 = cpbj.cplx;
            string gyms = cpbj.gyms;
            string bzyq = cpbj.bzyq;
            string tsyq = cpbj.tsyq;
            string many = cpbj.many;
            string sqr1 = cpbj.sqr;
            string type = cpbj.type;
            try
            {
                string cplx = "";
                if (cplx1 == "0")
                {
                    cplx = "新品";
                }
                else
                {
                    cplx = "常规";
                }
                OracleConnection conn = ToolHelper.OpenRavoerp("oa");
                string sql = " select * from HRMRESOURCE where id='" + sqr1 + "' ";
                OracleCommand cmd = new OracleCommand(sql, conn);
                OracleDataAdapter da = new OracleDataAdapter(cmd);
                DataTable dt = new DataTable();
                da.Fill(dt);
                string sqr = dt.Rows[0]["LASTNAME"].ToString();
                ToolHelper.CloseSql(conn);

                //先判断使用哪个数据库
                if (type == "0")
                {
                    conn = ToolHelper.OpenRavoerp("23");
                }
                else if (type == "1")
                {
                    conn = ToolHelper.OpenRavoerp("21");
                }
                else if (type == "3")
                {
                    conn = ToolHelper.OpenRavoerp("141");
                }
                else
                {
                    conn = ToolHelper.OpenRavoerp("22");
                }

                if (conn != null)
                {
                    sql = " select * from BJD_HEAD where oaid='" + oaid + "' and cpmc='" + cpmc + "' and bzyq='"+bzyq+"' ";
                    cmd = new OracleCommand(sql, conn);
                    da = new OracleDataAdapter(cmd);
                    dt = new DataTable();
                    da.Fill(dt);
                    ToolHelper.CloseSql(conn);
                    var num = dt.Rows.Count;
                    if (num == 0)
                    {
                        //conn = ToolHelper.OpenRavoerp("oa");
                        //sql = " select a.ID,A.lcbh,B.cpmc from FORMTABLE_MAIN_279 A left join FORMTABLE_MAIN_279_DT1 B on a.id=b.mainid where a.lcbh='" + oaid + "' and b.cpmc='" + cpmc + "' ";
                        //cmd = new OracleCommand(sql, conn);
                        //da = new OracleDataAdapter(cmd);
                        //dt = new DataTable();
                        //da.Fill(dt);
                        //string id = dt.Rows[0]["ID"].ToString();
                        //ToolHelper.CloseSql(conn);
                        //修改 增加子表id (暂未修改)

                        SqlSaveHelper.SaveCPBJ(type, oaid, cpmc, cplx, gyms, bzyq, tsyq, many, sqr);
                        return "成功";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                return "失败";
                throw;
            }
        }
        /// <summary>
        /// 企业微信短号维护
        /// </summary>
        /// <returns></returns>
        [WebMethod]
        public string AAA()
        {
            //开始
            try
            {
                int no = 0;
                string s = "";
                string id = "";
                //获取wxID
                OracleConnection conn = ToolHelper.OpenRavoerp("oa");
                string sql = " select userid,shortno from WX_SHORTNO where status=0 ";
                OracleCommand cmd = new OracleCommand(sql, conn);
                OracleDataAdapter da = new OracleDataAdapter(cmd);
                DataTable dt = new DataTable();
                da.Fill(dt);
                no = dt.Rows.Count;
                ToolHelper.CloseSql(conn);
                for (int i = 0; i < no; i++)
                {
                    s = dt.Rows[i]["shortno"].ToString();
                    id = dt.Rows[i]["userid"].ToString();
                    //先获取token，再获取职员信息 再修改
                    string corpid = "ww226ac420227ca99f";
                    string corpsecret = "RJImeiGrEG7b6146BB4WWT0oTY1NmjBElRLsiOhUW3M";
                    string accessToken = QYWeixinHelper.GetQYAccessToken(corpid, corpsecret);
                    //再获取职员信息
                    string url = "https://qyapi.weixin.qq.com/cgi-bin/user/get?access_token=" + accessToken + "&userid="+id ;
                    string res = ToolHelper.GetHttpResponse(url, 6000);
                    UserInfo userIDInfo = new JavaScriptSerializer().Deserialize<UserInfo>(res);
                    if (userIDInfo.errcode == 0)
                    {
                        UpdateUserInfo user = new UpdateUserInfo();
                        user.userid = userIDInfo.userid;
                        user.name = userIDInfo.name;
                        user.alias = userIDInfo.alias;
                        user.mobile = userIDInfo.mobile;
                        user.department = userIDInfo.department;
                        user.order = userIDInfo.order;
                        user.position = userIDInfo.position;
                        user.gender = userIDInfo.gender;
                        user.email = userIDInfo.email;
                        user.telephone = userIDInfo.telephone;
                        user.is_leader_in_dept = userIDInfo.is_leader_in_dept;
                        user.avatar_mediaid = "";
                        user.enable = userIDInfo.enable;
                        List<AttrsItem> aList = new List<AttrsItem>();
                        Text t = new Text();
                        t.value = s;
                        AttrsItem at = new AttrsItem();
                        at.name = "手机短号";
                        at.type = 0;
                        at.text = t;
                        aList.Add(at);
                        Extattr extattr = new Extattr();
                        extattr.attrs = aList;
                        user.extattr = extattr;
                        user.external_profile = null;
                        //user.external_profile.external_corp_name = "";
                        user.external_position = "";
                        user.address = userIDInfo.@address;
                        string strJson = JsonConvert.SerializeObject(user);
                        //post请求
                        url = "https://qyapi.weixin.qq.com/cgi-bin/user/update?access_token=" + accessToken;
                        string param = strJson;
                        string callback = ToolHelper.Post(url, param);
                        SendMessageInfo mes = new JavaScriptSerializer().Deserialize<SendMessageInfo>(callback);
                        if (Convert.ToString(mes.errcode)=="0")
                        {
                            //修改已成功的状态
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update WX_SHORTNO set status=1 where userid='" + id + "'";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                        }
                        else
                        {
                            string aaaa = "";
                        }
                    }


                    string a = "";


                }
                return "1";

            }
            catch (Exception ee)
            {
                string aa = ee.ToString();
                return "0";
                throw;
            }
        }
        #region 考勤
        /// <summary>
        /// 获取请假时长
        /// </summary>{"manid":"501485","startTime":"2019-10-06 08:00","endTime":"2019-10-06 20:00","dptID":"52"}
        /// <param name="userID"></param>
        /// <param name="startTime"></param>
        /// <param name="endTime"></param>
        /// <returns></returns>
        [WebMethod]
        public string GetLeaveTime(string time)
        {
           
            LeaveTime leaveTime = new JavaScriptSerializer().Deserialize<LeaveTime>(time);
            string manid = leaveTime.manid;
            string startTime = leaveTime.startTime;
            string endTime = leaveTime.endTime;
            string dptID = leaveTime.dptID;
            double x = 0;
            string type = "";
            try
            {
                //先查询所在分部
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    string sql = " select subcompanyid1 from hrmdepartment@ECOLOGY where id='" + dptID + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    type = dt.Rows[0]["subcompanyid1"].ToString();
                    ToolHelper.CloseSql(conn);
                    if (type != null)
                    {
                        DateTime start = Convert.ToDateTime(startTime);
                        DateTime end = Convert.ToDateTime(endTime);
                        DateTime ss = Convert.ToDateTime(start.ToString("yyyy-MM-dd"));
                        DateTime ee = Convert.ToDateTime(end.ToString("yyyy-MM-dd"));
                        TimeSpan ts = ee - ss;
                        //var day = Math.Ceiling((decimal)ts.TotalDays);
                        var day = Math.Ceiling((decimal)ts.TotalDays);

                        for (int i = 0; i < day + 1; i++)
                        {
                            conn = ToolHelper.OpenRavoerp(type);
                            string startday = start.AddDays(i).ToString("yyyyMMdd");
                            if (conn != null)
                            {
                                sql = " select * from t_kqbc_dept where manid='" + manid + "' and dayid='" + startday + "' and state='4' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                ToolHelper.CloseSql(conn);
                                var num = dt.Rows.Count;
                                if (num == 0)
                                {
                                    x = x + 0;
                                }
                                else
                                {
                                    string bcid = dt.Rows[0]["BCID"].ToString();
                                    if (bcid == "0" && i == 0)
                                    {
                                        string startday1 = start.AddDays(-1).ToString("yyyyMMdd");
                                        conn = ToolHelper.OpenRavoerp(type);
                                        sql = " select * from t_kqbc_dept where manid='" + manid + "' and dayid='" + startday1 + "' and state='4' ";
                                        cmd = new OracleCommand(sql, conn);
                                        da = new OracleDataAdapter(cmd);
                                        dt = new DataTable();
                                        da.Fill(dt);
                                        ToolHelper.CloseSql(conn);
                                        bcid = dt.Rows[0]["BCID"].ToString();
                                    }

                                    conn = ToolHelper.OpenRavoerp(type);
                                    //string bcid = "18";
                                    sql = " select * from VH_LIST_KQBC where bcid='" + bcid + "' order by indexs ";
                                    cmd = new OracleCommand(sql, conn);
                                    da = new OracleDataAdapter(cmd);
                                    dt = new DataTable();
                                    da.Fill(dt);
                                    int n = dt.Rows.Count;
                                    if (n > 1)
                                    {
                                        if (n == 2)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string rests = dt.Rows[1]["RESTS"].ToString();
                                            string xbTime = dt.Rows[1]["XBTIME"].ToString();
                                            string xeTime = dt.Rows[1]["XETIME"].ToString();

                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            if (rests == "0")
                                            {
                                                if (i == 0)//第一天
                                                {
                                                    if (day == 0)//只有一天
                                                    {
                                                        if (ks <= bt1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - bt1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                            }
                                                            else if (js < et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                            }
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                            }
                                                            else if (js <= et2)//已修改 分两段
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et1 - ks;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                            }

                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                            }
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            if (js <= et2)//已修改
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                            }
                                                        }
                                                    }
                                                    else if (i != day)//其中的第一天
                                                    {
                                                        if (ks <= bt1)
                                                        {
                                                            x = x + t1 + t2;
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            TimeSpan ts1 = et1 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            x = x + t2;
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                }
                                                else if (i == day)//最后一天
                                                {
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1;
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        TimeSpan ts1 = js - bt2;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t1;
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        TimeSpan ts1 = js - bt1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else//当中几天
                                                {
                                                    x = x + t1 + t2;
                                                }
                                            }
                                            else
                                            {
                                                DateTime xb = Convert.ToDateTime(xbTime);
                                                DateTime xe = Convert.ToDateTime(xeTime);
                                                double t = Convert.ToDouble(times2);
                                                double r = Convert.ToDouble(rests);
                                                if (i == 0)//第一天
                                                {
                                                    if(bt1<et2)//不跨天
                                                    {
                                                        if (day == 0)//请假开始结束都在同一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                if (js <= et1)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                }
                                                                else if (js >= bt2)
                                                                {
                                                                    if (js <= xb)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                    }
                                                                    else if (js >= xe)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2 - r;
                                                                    }
                                                                    else
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                    }

                                                                }

                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if(xe >= js && js >= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                }
                                                                else if(ks<=xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                }
                                                                else if (ks>=xe)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x +t1+t2-r;
                                                            }
                                                        }
                                                        else if (i != day)//请假有n天,只是其中的第一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if (xe >= ks && ks >= xb)
                                                                {
                                                                    TimeSpan ts1 = et2-xe;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 ;
                                                                }
                                                                else if(ks <=xb )
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                }else
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else//跨天 
                                                    {

                                                    }
                                                }
                                                else if (i == day)//最后一天
                                                {
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1-r;
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        if (js >= xe)
                                                        {
                                                            TimeSpan ts1 = js - xe;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = xb - bt2;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2 + t1;
                                                        }
                                                        else
                                                        {
                                                            if (xe >= js && js >= xb)
                                                            {
                                                                TimeSpan ts1 = xb - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                            }
                                                            else
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                            }
                                                            
                                                        }
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        x = x + 0;
                                                        //TimeSpan ts1 = js - bt1;
                                                        //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        //x = x + d1;
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else//当中几天
                                                {
                                                    x = x + t1 + t2 - r;
                                                }
                                            }
                                        }
                                        else if (n == 3)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string bTime3 = dt.Rows[2]["BTIME"].ToString();
                                            string eTime3 = dt.Rows[2]["ETIME"].ToString();
                                            string times3 = dt.Rows[2]["TIMES"].ToString();
                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            DateTime bt3 = Convert.ToDateTime(bTime3);
                                            DateTime et3 = Convert.ToDateTime(eTime3);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            double t3 = Convert.ToDouble(times3);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            if (i == 0)//第一天
                                            {
                                                if (day == 0)//只有一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - bt1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t1 + t2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - ks;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = et1 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }

                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        if (js <= et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= bt3)
                                                        {
                                                            x = x + t2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= bt3)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = js - bt3;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js >= et3)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = js - bt3;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        if (js <= bt3)
                                                        {
                                                            x = x + 0;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                        else
                                                        {
                                                            x = x + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                        }
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = et3 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        x = ToolHelper.LeaveTimeTotal(x);
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                        x = ToolHelper.LeaveTimeTotal(x);
                                                    }
                                                }
                                                else if (i != day)//其中的第一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        x = x + t1 + t2 + t3;
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        TimeSpan ts1 = et1 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t2 + t3;
                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        x = x + t2 + t3;
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        TimeSpan ts1 = et2 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t3;
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        x = x + t3;
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = et3 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                            }
                                            else if (i == day)//最后一天
                                            {
                                                if (js >= et3)
                                                {
                                                    x = x + t1 + t2 + t3;
                                                }
                                                else if (js >= bt3)
                                                {
                                                    TimeSpan ts1 = js - bt3;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t2 + t1;
                                                }
                                                else if (js >= et2)
                                                {
                                                    x = x + t2 + t1;
                                                }
                                                else if (js >= bt2)
                                                {
                                                    TimeSpan ts1 = js - bt2;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t1;
                                                }
                                                else if (js >= et1)
                                                {
                                                    x = x + t1;
                                                }
                                                else if (js > bt1)
                                                {
                                                    TimeSpan ts1 = js - bt1;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1;
                                                }
                                                else
                                                {
                                                    x = x + 0;
                                                }
                                            }
                                            else//当中几天
                                            {
                                                x = x + t1 + t2 + t3;
                                            }
                                        }
                                    }
                                    //一个排班分多个段
                                    else if (n == 1)
                                    {
                                        string bTime = dt.Rows[0]["BTIME"].ToString();
                                        string eTime = dt.Rows[0]["ETIME"].ToString();
                                        string times = dt.Rows[0]["TIMES"].ToString();
                                        string rests = dt.Rows[0]["RESTS"].ToString();
                                        string xbTime = dt.Rows[0]["XBTIME"].ToString();
                                        string xeTime = dt.Rows[0]["XETIME"].ToString();
                                        ToolHelper.CloseSql(conn);
                                        DateTime bt = Convert.ToDateTime(bTime);
                                        DateTime et = Convert.ToDateTime(eTime);
                                        DateTime xb = Convert.ToDateTime(xbTime);
                                        DateTime xe = Convert.ToDateTime(xeTime);
                                        double t = Convert.ToDouble(times);
                                        double r = Convert.ToDouble(rests);
                                        DateTime st1 = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                        DateTime et1 = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                        DateTime zero = Convert.ToDateTime("00:00");
                                        DateTime max = Convert.ToDateTime("23:59");
                                        DateTime one = Convert.ToDateTime("00:01");

                                        string strDate = start.ToString("yyyy-MM-dd");
                                        DateTime startDate = Convert.ToDateTime(strDate);
                                        //先判断是否是第一天还是最后一天 先不考虑分段排班情况
                                        if (i == 0)
                                        {

                                            if (bt < et)//不跨天
                                            {
                                                if (day == 0)//请假开始结束都在同一天
                                                {
                                                    if (st1 >= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = et1 - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - st1;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 >= bt && et1 >= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {

                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            if (st1 >= xe)
                                                            {
                                                                TimeSpan ts2 = et - st1;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d2;
                                                            }
                                                            else
                                                            {
                                                                TimeSpan ts2 = et - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d2;
                                                            }

                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 >= et)
                                                    {
                                                        x = t - r;
                                                    }
                                                }
                                                else if (i != day)//请假有n天,只是其中的第一天
                                                {
                                                    if (st1 >= bt)
                                                    {
                                                        if (st1 >= et)
                                                        {
                                                            x = x + 0;
                                                        }
                                                        else
                                                        {
                                                            if (st1 <= xb)
                                                            {
                                                                TimeSpan ts1 = xb - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                            }
                                                            else if (st1 >= xb && st1 >= xe)
                                                            {
                                                                TimeSpan ts1 = et - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                            }
                                                            else
                                                            {
                                                                x = x + 0;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (bt <= xb)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                        }
                                                        else if (bt >= xb && bt >= xe)
                                                        {
                                                            TimeSpan ts1 = et - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }

                                                    }

                                                }
                                            }
                                            else if (bt > et)//跨天
                                            {
                                                if (day == 0)//只有一天
                                                {
                                                    if (st1 >= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                        x = x + d1;

                                                    }
                                                    else if (st1 >= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                        x = x + d1;
                                                    }
                                                    else if (st1 <= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                        x = x + d1;
                                                    }
                                                    else if (st1 <= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                        x = x + d1;
                                                    }
                                                }
                                                else if (i != day)
                                                {
                                                    if (st1 >= bt)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                        TimeSpan ts2 = et - xe;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 1);
                                                        x = x + d1 + d2;
                                                    }
                                                    else
                                                    {
                                                        //TimeSpan ts1 = xb - bt;
                                                        //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        //TimeSpan ts2 = et - xe;
                                                        //double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                        //x = x + d1 + d2;
                                                        TimeSpan ts2 = et - st1;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 1);
                                                        x = x + d2;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else if (i == day)//最后一天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                //if (et1 >= et)
                                                //{
                                                //    TimeSpan ts1 = et - xe;
                                                //    double d1 = Math.Round((double)(t - r));
                                                //    x = x + d1;
                                                //    string kssj = Convert.ToString(Convert.ToDateTime(strDate).AddDays(i));
                                                //    OracleManager.Instance.OpenDb();
                                                //    OracleManager.Instance.CallProcCC(manid, qjlx, kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                //    OracleManager.Instance.CloseDb();
                                                //}
                                                //else
                                                //{
                                                if (et1 <= bt)
                                                {
                                                    x = x + 0;
                                                }
                                                else
                                                {
                                                    if (et1 >= xb && et1 >= xe)
                                                    {
                                                        if (et1 >= et)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                        }
                                                        else
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                        }
                                                    }
                                                    else if (et1 >= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = xb - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                    }
                                                    else if (et1 <= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                    }
                                                    else if (et1 <= xb && et1 >= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                    }
                                                }
                                                //}
                                            }
                                            else if (bt > et)//跨天 
                                            {
                                                if (et1 <= et)
                                                {
                                                    //TimeSpan ts1 = et1 - xe;
                                                    //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    //TimeSpan ts2 = xb - bt;
                                                    //double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                    //double s = x + d1 + d2;
                                                    x = x + 0;
                                                }
                                                else
                                                {
                                                    if (et1 >= et && et1 <= bt)
                                                    {
                                                        x = x + 0;
                                                    }
                                                    else
                                                    {
                                                        if (et1 <= xb && et1 >= xe)
                                                        {
                                                            if (et1 >= bt)
                                                            {
                                                                TimeSpan ts1 = et1 - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1;
                                                            }
                                                            else
                                                            {
                                                                //et1 = et1.AddHours(24);
                                                                TimeSpan ts1 = xb - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                TimeSpan ts2 = et1 - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 1);
                                                                x = x + d1 + d2;
                                                            }

                                                        }
                                                        else if (et1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                            x = x + d1;
                                                        }
                                                    }
                                                }

                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else//n天当中的几天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                x = x + t - r;
                                            }
                                            else//跨天
                                            {
                                                x = x + t - r;
                                                //TimeSpan ts1 = xb - bt;
                                                //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                //x = x + d1;
                                            }

                                        }
                                    }
                                }
                            }
                            else
                            {
                                break;
                            }
                        }
                    }
                }
                double tt = x;
                double total = 0;
                if (tt % 1 == 0)
                {
                    total = tt;
                }
                else
                {
                    double b = Math.Floor(tt);
                    double c = tt - b;
                    if (c > 0.5)
                    {
                        total = b + 1;
                    }
                    else
                    {
                        total = b + 0.5;
                    }
                }
                string z = Convert.ToString(total);
                return z;
            }
            catch (Exception ex)
            {
                ToolHelper.logger.Debug(ex.ToString());
                return Convert.ToString(0);
            }
        }
        /// <summary>
        /// 判断是否在排班内
        /// </summary>
        /// <param name="manid"></param>
        /// <param name="startTime"></param>
        /// <param name="endTime"></param>
        /// <returns></returns>
        [WebMethod]
        public string GetIsPB(string time)
        {
            GetIsPBInfo g = new JavaScriptSerializer().Deserialize<GetIsPBInfo>(time);
            string manid = g.manid;
            string startTime = g.startTime;
            string dptID = g.dptID;
            string type = "";
            try
            {
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    string sql = " select subcompanyid1 from hrmdepartment@ECOLOGY where id='" + dptID + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    type = dt.Rows[0]["subcompanyid1"].ToString();
                    ToolHelper.CloseSql(conn);
                    if (type != null)
                    {
                        conn = ToolHelper.OpenRavoerp(type);
                        if (conn != null)
                        {
                            DateTime time1 = Convert.ToDateTime(startTime);
                            string start = time1.ToString("yyyyMMdd");
                            string t = time1.ToString("HH:mm");
                            DateTime time2 = time1.AddDays(-1);
                            string start2= time2.ToString("yyyyMMdd");
                            sql = " select count(*) x from T_KQBC_DEPT where MANID='" + manid + "' and DAYID='" + start + "' and state='4' ";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string x = dt.Rows[0]["x"].ToString();
                            ToolHelper.CloseSql(conn);
                            int y = Convert.ToInt32(x);
                            if (y == 0)
                            {
                                conn = ToolHelper.OpenRavoerp(type);
                                sql = " select count(*) x from T_KQBC_DEPT where MANID='" + manid + "' and DAYID='" + start2 + "' and state='4' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                string x1 = dt.Rows[0]["x"].ToString();
                                int y1 = Convert.ToInt32(x1);
                                ToolHelper.CloseSql(conn);
                                if (y1 == 1)
                                {
                                    conn = ToolHelper.OpenRavoerp(type);
                                    sql = " select bcid from T_KQBC_DEPT where MANID='" + manid + "' and DAYID='" + start2 + "' and state='4' ";
                                    cmd = new OracleCommand(sql, conn);
                                    da = new OracleDataAdapter(cmd);
                                    dt = new DataTable();
                                    da.Fill(dt);
                                    string bcid = dt.Rows[0]["bcid"].ToString();
                                    ToolHelper.CloseSql(conn);

                                    conn = ToolHelper.OpenRavoerp(type);
                                    sql = " select * from VH_LIST_KQBC where bcid='" + bcid + "'";
                                    cmd = new OracleCommand(sql, conn);
                                    da = new OracleDataAdapter(cmd);
                                    dt = new DataTable();
                                    da.Fill(dt);
                                    string btime = dt.Rows[0]["btime"].ToString();
                                    string etime = dt.Rows[0]["etime"].ToString();
                                    ToolHelper.CloseSql(conn);
                                    string bttime1 = btime.Substring(0, 2);
                                    string ettime1 = etime.Substring(0, 2);
                                    int bt = Convert.ToInt32(bttime1);
                                    int et = Convert.ToInt32(ettime1);
                                    if (et < bt)
                                    {
                                        string t1 = t.Substring(0, 2);
                                        int t2=Convert.ToInt32(t1);
                                        if (et<=t2)
                                        {
                                            return "1";
                                        }
                                        else
                                        {
                                            return "0";
                                        }
                                    }
                                    else
                                    {
                                        return "0";
                                    }
                                }
                                else
                                {
                                    return "0";
                                }

                            }
                            else if (y == 1)
                            {
                                conn = ToolHelper.OpenRavoerp(type);
                                sql = " select bcid from T_KQBC_DEPT where MANID='" + manid + "' and DAYID='" + start + "' and state='4' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                ToolHelper.CloseSql(conn);
                                var num = dt.Rows.Count;
                                if (num > 0)
                                {
                                    conn = ToolHelper.OpenRavoerp(type);
                                    string bcid = dt.Rows[0]["bcid"].ToString();
                                    if (bcid == "0")
                                    {
                                        string starta = time1.AddDays(-1).ToString("yyyyMMdd");
                                        conn = ToolHelper.OpenRavoerp(type);
                                        sql = " select bcid from T_KQBC_DEPT where MANID='" + manid + "' and DAYID='" + starta + "' and state='4' ";
                                        cmd = new OracleCommand(sql, conn);
                                        da = new OracleDataAdapter(cmd);
                                        dt = new DataTable();
                                        da.Fill(dt);
                                        ToolHelper.CloseSql(conn);
                                        bcid = dt.Rows[0]["bcid"].ToString();
                                    }
                                    conn = ToolHelper.OpenRavoerp(type);
                                    sql = " select btime,etime,xbtime,xetime from VH_LIST_KQBC where bcid='" + bcid + "'";
                                    cmd = new OracleCommand(sql, conn);
                                    da = new OracleDataAdapter(cmd);
                                    dt = new DataTable();
                                    da.Fill(dt);
                                    ToolHelper.CloseSql(conn);
                                    num = dt.Rows.Count;
                                    if (num == 1)
                                    {
                                        string btime = dt.Rows[0]["btime"].ToString();
                                        string etime = dt.Rows[0]["etime"].ToString();
                                        string xbtime = dt.Rows[0]["xbtime"].ToString();
                                        string xetime = dt.Rows[0]["xetime"].ToString();
                                        if (xbtime == "" && xetime == "")
                                        {
                                            if (Convert.ToDateTime(etime) < Convert.ToDateTime(btime))
                                            {
                                                //跨天
                                                return "1";
                                            }
                                            else//不跨天
                                            {
                                                if (Convert.ToDateTime(btime) <= Convert.ToDateTime(t) && Convert.ToDateTime(t) <= Convert.ToDateTime(etime))
                                                {
                                                    return "1";
                                                }
                                                else
                                                {
                                                    return "0";
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //判断是否跨天
                                            if (Convert.ToDateTime(etime) < Convert.ToDateTime(btime))
                                            {
                                                if (Convert.ToDateTime(btime) <= Convert.ToDateTime(t) && Convert.ToDateTime(t) <= Convert.ToDateTime(xbtime))
                                                {
                                                    return "1";
                                                }
                                                else if (Convert.ToDateTime(xetime) <= Convert.ToDateTime(t) && Convert.ToDateTime(t) <= Convert.ToDateTime(etime))
                                                {
                                                    return "1";
                                                }
                                                else
                                                {
                                                    return "1";
                                                }
                                            }
                                            else//不跨天
                                            {
                                                if (Convert.ToDateTime(xbtime) < Convert.ToDateTime(t) && Convert.ToDateTime(t) < Convert.ToDateTime(xetime))
                                                {
                                                    return "0";
                                                }
                                                else
                                                {
                                                    if (Convert.ToDateTime(btime) < Convert.ToDateTime(etime) && Convert.ToDateTime(t) < Convert.ToDateTime(etime))
                                                    {
                                                        return "1";
                                                    }
                                                    //else if (Convert.ToDateTime(btime) > Convert.ToDateTime(etime) && Convert.ToDateTime(t) > Convert.ToDateTime(btime) || Convert.ToDateTime(btime) > Convert.ToDateTime(etime) && Convert.ToDateTime(t) < Convert.ToDateTime(etime))
                                                    else if (Convert.ToDateTime(etime) >= Convert.ToDateTime(btime) && Convert.ToDateTime(btime) <= Convert.ToDateTime(t) || Convert.ToDateTime(etime) >= Convert.ToDateTime(btime) && Convert.ToDateTime(t) <= Convert.ToDateTime(etime))
                                                    {
                                                        return "1";
                                                    }
                                                }

                                            }
                                        }

                                    }
                                    else if (num > 1)
                                    {
                                        for (int i = 0; i < num; i++)
                                        {
                                            //if (num == 2)
                                            //{
                                            //    string btime = dt.Rows[i]["btime"].ToString();
                                            //    string etime = dt.Rows[i]["etime"].ToString();
                                            //    string btime = dt.Rows[i]["btime"].ToString();
                                            //    string etime = dt.Rows[i]["etime"].ToString();
                                            //}
                                            //else if (num == 3)
                                            //{

                                            //}
                                            string btime = dt.Rows[i]["btime"].ToString();
                                            string etime = dt.Rows[i]["etime"].ToString();
                                            if (Convert.ToDateTime(btime) <= Convert.ToDateTime(etime) && Convert.ToDateTime(t) <= Convert.ToDateTime(etime))
                                            {
                                                return "1";
                                            }
                                            //else if (Convert.ToDateTime(btime) > Convert.ToDateTime(etime) && Convert.ToDateTime(t) > Convert.ToDateTime(btime) || Convert.ToDateTime(btime) > Convert.ToDateTime(etime) && Convert.ToDateTime(t) < Convert.ToDateTime(etime))
                                            else if (Convert.ToDateTime(etime) <= Convert.ToDateTime(btime) && Convert.ToDateTime(btime) <= Convert.ToDateTime(t) || Convert.ToDateTime(etime) <= Convert.ToDateTime(btime) && Convert.ToDateTime(t) <= Convert.ToDateTime(etime))
                                            {
                                                return "1";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return "0";
                }
                return "0";
            }
            catch (Exception ex)
            {
                ToolHelper.logger.Debug(ex.ToString());
                return "0";
            }
        }

        /// <summary>
        /// 存储请假信息
        /// </summary>{"manid":"507514","startTime":"2019-09-06 16:00","endTime":"2019-09-06 20:00","qjlx":"0","oaNo":"R2-QJSQD2019090694","dptID":"52"}
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveLeaveTime(string time)
        {
            SaveLeaveTime leaveTime = new JavaScriptSerializer().Deserialize<SaveLeaveTime>(time);
            string manid = leaveTime.manid;
            string startTime = leaveTime.startTime;
            string endTime = leaveTime.endTime;
            string qjlx = leaveTime.qjlx;
            if (qjlx == "0")
            {
                qjlx = "1";
            }
            else if (qjlx == "1")
            {
                qjlx = "6";
            }
            else if (qjlx == "2")
            {
                qjlx = "1";
            }
            string oaNo = leaveTime.oaNo;
            string dptID = leaveTime.dptID;
            string type = "";
            try
            {
                DateTime start = Convert.ToDateTime(startTime);
                DateTime end = Convert.ToDateTime(endTime);
                DateTime ss = Convert.ToDateTime(start.ToString("yyyy-MM-dd"));
                DateTime ee = Convert.ToDateTime(end.ToString("yyyy-MM-dd"));
                TimeSpan ts = ee - ss;
                var day = Math.Ceiling((decimal)ts.TotalDays);
                double x = 0;
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    string sql = " select subcompanyid1 from hrmdepartment@ECOLOGY where id='" + dptID + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    type = dt.Rows[0]["subcompanyid1"].ToString();
                    ToolHelper.CloseSql(conn);
                    if (type != null)
                    {
                        for (int i = 0; i < day + 1; i++)
                        {
                            conn = ToolHelper.OpenRavoerp(type);
                            string startday = start.AddDays(i).ToString("yyyyMMdd");
                            if (conn != null)
                            {
                                sql = " select * from t_kqbc_dept where manid='" + manid + "' and dayid='" + startday + "' and state='4' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                var num = dt.Rows.Count;
                                ToolHelper.CloseSql(conn);
                                if (num == 0)
                                {
                                    x = x + 0;
                                }
                                else
                                {
                                    string bcid = dt.Rows[0]["BCID"].ToString();
                                    if (bcid == "0" && i == 0)
                                    {
                                        string startday1 = start.AddDays(-1).ToString("yyyyMMdd");
                                        conn = ToolHelper.OpenRavoerp(type);
                                        sql = " select * from t_kqbc_dept where manid='" + manid + "' and dayid='" + startday1 + "' and state='4' ";
                                        cmd = new OracleCommand(sql, conn);
                                        da = new OracleDataAdapter(cmd);
                                        dt = new DataTable();
                                        da.Fill(dt);
                                        ToolHelper.CloseSql(conn);
                                        bcid = dt.Rows[0]["BCID"].ToString();
                                    }
                                    conn = ToolHelper.OpenRavoerp(type);
                                    sql = " select * from VH_LIST_KQBC where bcid='" + bcid + "' order by indexs ";
                                    cmd = new OracleCommand(sql, conn);
                                    da = new OracleDataAdapter(cmd);
                                    dt = new DataTable();
                                    da.Fill(dt);
                                    int n = dt.Rows.Count;
                                    if (n > 1)
                                    {
                                        if (n == 2)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string rests = dt.Rows[1]["RESTS"].ToString();
                                            string xbTime = dt.Rows[1]["XBTIME"].ToString();
                                            string xeTime = dt.Rows[1]["XETIME"].ToString();
                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            string strDate = start.ToString("yyyy-MM-dd");
                                            if (rests == "0")
                                            {
                                                if (i == 0)//第一天
                                                {
                                                    if (day == 0)//只有一天
                                                    {

                                                        if (ks <= bt1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - bt1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                //先判断是否要存储
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js < et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et1 - ks;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                                }

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                //修复错误dayy错误 19/12/05
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else if (i != day)//其中的第一天
                                                    {
                                                        if (ks <= bt1)
                                                        {
                                                            x = x + t1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            TimeSpan ts1 = et1 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            x = x + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                }
                                                else if (i == day)//最后一天
                                                {
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        TimeSpan ts1 = js - bt2;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        TimeSpan ts1 = js - bt1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else//当中几天
                                                {
                                                    x = x + t1 + t2;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                DateTime xb = Convert.ToDateTime(xbTime);
                                                DateTime xe = Convert.ToDateTime(xeTime);
                                                double t = Convert.ToDouble(times2);
                                                double r = Convert.ToDouble(rests);
                                                if (i == 0)//第一天
                                                {
                                                    if (bt1 < et2)//不跨天
                                                    {
                                                        if (day == 0)//请假开始结束都在同一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                if (js <= et1)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                    //先判断是否要存储
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (js >= bt2)
                                                                {
                                                                    if (js <= xb)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                        }
                                                                    }
                                                                    else if (js >= xe)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2 - r;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2 - r), rests, oaNo);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                        }
                                                                    }

                                                                }

                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if (xe >= js && js >= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1+t1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks <= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                                    }
                                                                }
                                                                else if (ks >= xe)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 ;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (i != day)//请假有n天,只是其中的第一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1+t2-r), rests, oaNo);
                                                                }
                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t2 - r), rests, oaNo);
                                                                }
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if (xe >= ks && ks >= xb)
                                                                {
                                                                    TimeSpan ts1 = et2 - xe;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 ;
                                                                    string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks <= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else//跨天 
                                                    {

                                                    }
                                                }
                                                else if (i == day)//最后一天
                                                {
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1 - r;
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                        }
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        if (js >= xe)
                                                        {
                                                            TimeSpan ts1 = js - xe;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = xb - bt2;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2 + t1;
                                                            string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1+d2+t1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (xe >= js && js >= xb)
                                                            {
                                                                TimeSpan ts1 = xb - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1+t1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1+t1), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        x = x + 0;
                                                        //TimeSpan ts1 = js - bt1;
                                                        //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        //x = x + d1;
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else//当中几天
                                                {
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    x = x + t1 + t2 - r;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                    }
                                                }
                                            }

                                        }
                                        if (n == 3)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string bTime3 = dt.Rows[2]["BTIME"].ToString();
                                            string eTime3 = dt.Rows[2]["ETIME"].ToString();
                                            string times3 = dt.Rows[2]["TIMES"].ToString();
                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            DateTime bt3 = Convert.ToDateTime(bTime3);
                                            DateTime et3 = Convert.ToDateTime(eTime3);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            double t3 = Convert.ToDouble(times3);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            string strDate = start.ToString("yyyy-MM-dd");
                                            if (i == 0)//第一天
                                            {
                                                if (day == 0) //只有一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - bt1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t1 + t2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - ks;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = et1 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }

                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        if (js <= et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt3)
                                                        {
                                                            x = x + t2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt3)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = js - bt3;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js >= et3)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = js - bt3;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        if (js <= bt3)
                                                        {
                                                            x = x + 0;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t3;
                                                            x = ToolHelper.LeaveTimeTotal(x);
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = js - bt3;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        x = ToolHelper.LeaveTimeTotal(x);
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                        x = ToolHelper.LeaveTimeTotal(x);
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(x), "0", oaNo);
                                                        }
                                                    }
                                                }
                                                else if (i != day)//其中的第一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        x = x + t1 + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        TimeSpan ts1 = et1 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        x = x + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        TimeSpan ts1 = et2 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        x = x + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = et3 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                            }
                                            else if (i == day)//最后一天
                                            {
                                                if (js >= et3)
                                                {
                                                    x = x + t1 + t2 + t3;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), kssj + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= bt3)
                                                {
                                                    TimeSpan ts1 = js - bt3;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t2 + t1;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= et2)
                                                {
                                                    x = x + t2 + t1;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= bt2)
                                                {
                                                    TimeSpan ts1 = js - bt2;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t1;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }

                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= et1)
                                                {
                                                    x = x + t1;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                }
                                                else if (js > bt1)
                                                {
                                                    TimeSpan ts1 = js - bt1;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else
                                                {
                                                    x = x + 0;
                                                }
                                            }
                                            else//当中几天
                                            {
                                                x = x + t1 + t2 + t3;
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                }
                                                dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                }
                                                dayy = kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), kssj + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                }
                                            }
                                        }
                                    }
                                    //一个排班分多个段
                                    else if (n == 1)
                                    {
                                        string bTime = dt.Rows[0]["BTIME"].ToString();
                                        string eTime = dt.Rows[0]["ETIME"].ToString();
                                        string times = dt.Rows[0]["TIMES"].ToString();
                                        string rests = dt.Rows[0]["RESTS"].ToString();
                                        string xbTime = dt.Rows[0]["XBTIME"].ToString();
                                        string xeTime = dt.Rows[0]["XETIME"].ToString();
                                        ToolHelper.CloseSql(conn);
                                        DateTime bt = Convert.ToDateTime(bTime);
                                        DateTime et = Convert.ToDateTime(eTime);
                                        DateTime xb = Convert.ToDateTime(xbTime);
                                        DateTime xe = Convert.ToDateTime(xeTime);
                                        double t = Convert.ToDouble(times);
                                        double r = Convert.ToDouble(rests);
                                        DateTime st1 = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                        DateTime et1 = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                        string strDate = start.ToString("yyyy-MM-dd");
                                        DateTime startDate = Convert.ToDateTime(strDate);
                                        //先判断是否是第一天还是最后一天 先不考虑分段排班情况
                                        if (i == 0)
                                        {

                                            if (bt < et)//不跨天
                                            {
                                                if (day == 0)//请假开始结束都在同一天
                                                {
                                                    if (st1 >= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            //先判断是否要存储
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = et1 - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - st1;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 >= bt && et1 >= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            if (st1 >= xe)
                                                            {
                                                                TimeSpan ts2 = et - st1;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d2;
                                                                string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                TimeSpan ts2 = et - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d2;
                                                                string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                }
                                                else if (i != day)//请假有n天,只是其中的第一天
                                                {
                                                    if (st1 >= bt)
                                                    {
                                                        if (st1 >= et)
                                                        {
                                                            x = x + 0;
                                                        }
                                                        else
                                                        {
                                                            if (st1 <= xb)
                                                            {
                                                                TimeSpan ts1 = xb - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                                }
                                                            }
                                                            else if (st1 >= xb && st1 >= xe)
                                                            {
                                                                TimeSpan ts1 = et - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + 0;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (bt <= xb)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (bt >= xb && bt >= xe)
                                                        {
                                                            TimeSpan ts1 = et - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }

                                                    }

                                                }
                                            }
                                            else if (bt > et)//跨天
                                            {
                                                if (day == 0)//只有一天
                                                {
                                                    if (st1 >= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }

                                                    }
                                                    else if (st1 >= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = et - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = xb - bt;
                                                        double d2 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + d2;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                }
                                                //以上为只有一天
                                                else if (i != day)
                                                {

                                                    if (st1 >= bt)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                        TimeSpan ts2 = et - xe;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 1);
                                                        x = x + d1 + d2;
                                                        //跨天分2条存储
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(1);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        dayy = kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }

                                                    }
                                                    else
                                                    {
                                                        //TimeSpan ts1 = xb - bt;
                                                        //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        //TimeSpan ts2 = et - xe;
                                                        //double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                        //x = x + d1 + d2;
                                                        TimeSpan ts2 = et - st1;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 1);
                                                        x = x + d2;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(1);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }
                                                    }



                                                    //if (st1 < bt)
                                                    //{
                                                    //    TimeSpan ts1 = xb - st1;
                                                    //    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    //    TimeSpan ts2 = et - xe;
                                                    //    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                    //    x = x + d1 + d2;
                                                    //    //跨天分2条存储
                                                    //    string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                    //    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    //    conn = ToolHelper.OpenRavoerp(type);
                                                    //    cmd = new OracleCommand(sql, conn);
                                                    //    da = new OracleDataAdapter(cmd);
                                                    //    dt = new DataTable();
                                                    //    da.Fill(dt);
                                                    //    num = dt.Rows.Count;
                                                    //    ToolHelper.CloseSql(conn);
                                                    //    if (num == 0)
                                                    //    {
                                                    //        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                    //    }
                                                    //    DateTime aaa = Convert.ToDateTime(strDate).AddDays(1);
                                                    //    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    //    dayy = kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                    //    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    //    conn = ToolHelper.OpenRavoerp(type);
                                                    //    cmd = new OracleCommand(sql, conn);
                                                    //    da = new OracleDataAdapter(cmd);
                                                    //    dt = new DataTable();
                                                    //    da.Fill(dt);
                                                    //    num = dt.Rows.Count;
                                                    //    ToolHelper.CloseSql(conn);
                                                    //    if (num == 0)
                                                    //    {
                                                    //        SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                    //    }
                                                    //}
                                                    //else
                                                    //{
                                                    //    //开始时间等于排班开始时间
                                                    //    if (bt == st1)
                                                    //    {
                                                    //        x = x + t - r;
                                                    //        var bbb = start.AddDays(1);
                                                    //        string endDate = bbb.ToString("yyyy-MM-dd");
                                                    //        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                    //        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    //        conn = ToolHelper.OpenRavoerp(type);
                                                    //        cmd = new OracleCommand(sql, conn);
                                                    //        da = new OracleDataAdapter(cmd);
                                                    //        dt = new DataTable();
                                                    //        da.Fill(dt);
                                                    //        num = dt.Rows.Count;
                                                    //        ToolHelper.CloseSql(conn);
                                                    //        if (num == 0)
                                                    //        {
                                                    //            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), endDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(t - r), Convert.ToString(r), oaNo);
                                                    //        }
                                                    //    }
                                                    //    else
                                                    //    {
                                                    //        //需2段
                                                    //        TimeSpan ts1 = xb - st1;
                                                    //        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    //        TimeSpan ts2 = et - xe;
                                                    //        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                    //        x = x + d1 + d2;
                                                    //        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                    //        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    //        conn = ToolHelper.OpenRavoerp(type);
                                                    //        cmd = new OracleCommand(sql, conn);
                                                    //        da = new OracleDataAdapter(cmd);
                                                    //        dt = new DataTable();
                                                    //        da.Fill(dt);
                                                    //        num = dt.Rows.Count;
                                                    //        ToolHelper.CloseSql(conn);
                                                    //        if (num == 0)
                                                    //        {
                                                    //            SqlSaveHelper.SaveQJ(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                    //        }
                                                    //        var bbb = start.AddDays(1);
                                                    //        string endDate = bbb.ToString("yyyy-MM-dd");
                                                    //        dayy = endDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                    //        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    //        conn = ToolHelper.OpenRavoerp(type);
                                                    //        cmd = new OracleCommand(sql, conn);
                                                    //        da = new OracleDataAdapter(cmd);
                                                    //        dt = new DataTable();
                                                    //        da.Fill(dt);
                                                    //        num = dt.Rows.Count;
                                                    //        ToolHelper.CloseSql(conn);
                                                    //        if (num == 0)
                                                    //        {
                                                    //            SqlSaveHelper.SaveQJ(type, manid, qjlx, endDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), endDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                    //        }
                                                    //    }

                                                    //}
                                                }
                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else if (i == day)//最后一天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                //if (et1 >= et)
                                                //{
                                                //    TimeSpan ts1 = et - xe;
                                                //    double d1 = Math.Round((double)(t - r));
                                                //    x = x + d1;
                                                //    string kssj = Convert.ToString(Convert.ToDateTime(strDate).AddDays(i));
                                                //    OracleManager.Instance.OpenDb();
                                                //    OracleManager.Instance.CallProc(manid, qjlx, kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                //    OracleManager.Instance.CloseDb();
                                                //}
                                                //else
                                                //{
                                                if (et1 <= bt)
                                                {
                                                    x = x + 0;
                                                }
                                                else
                                                {
                                                    if (et1 >= xb && et1 >= xe)
                                                    {
                                                        if (et > et1)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                            string kssj = aaa.ToString("yyyy-MM-dd");
                                                            string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                            string kssj = aaa.ToString("yyyy-MM-dd");
                                                            string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }

                                                    }
                                                    else if (et1 >= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = xb - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (et1 <= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (et1 <= xb && et1 >= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                }
                                                //}
                                            }
                                            else if (bt > et)//跨天 weiwancheng
                                            {
                                                if (et1 <= et)
                                                {
                                                    //TimeSpan ts1 = et1 - xe;
                                                    //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    //TimeSpan ts2 = xb - bt;
                                                    //double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                    //double s = x + d1 + d2;
                                                    //x = s;
                                                    //DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    //string kssj = aaa.ToString("yyyy-MM-dd");
                                                    //string dayy = kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute);
                                                    //sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    //conn = ToolHelper.OpenRavoerp(type);
                                                    //cmd = new OracleCommand(sql, conn);
                                                    //da = new OracleDataAdapter(cmd);
                                                    //dt = new DataTable();
                                                    //da.Fill(dt);
                                                    //num = dt.Rows.Count;
                                                    //ToolHelper.CloseSql(conn);
                                                    //if (num == 0)
                                                    //{
                                                    //    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                    //}
                                                    x = x + 0;
                                                }
                                                else
                                                {
                                                    if (et1 >= et && et1 <= bt)
                                                    {
                                                        x = x + 0;
                                                    }
                                                    else
                                                    {
                                                        if (et1 <= xb && et1 >= xe)
                                                        {
                                                            if (et1 >= bt)
                                                            {
                                                                TimeSpan ts1 = et1 - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //et1 = et1.AddHours(24);
                                                                TimeSpan ts1 = xb - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                                TimeSpan ts2 = et1 - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                aaa = Convert.ToDateTime(strDate).AddDays(i + 1);
                                                                kssj = aaa.ToString("yyyy-MM-dd");
                                                                dayy = kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (et1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                            string kssj = aaa.ToString("yyyy-MM-dd");
                                                            string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else//n天当中的几天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                x = x + t - r;
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(t - r), rests, oaNo);
                                                }
                                            }
                                            else//跨天
                                            {
                                                if (i == (day - 1))
                                                {
                                                    if (et == et1)
                                                    {
                                                        x = x + t - r;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        DateTime bbb = Convert.ToDateTime(strDate).AddDays(i + 1);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string jssj = bbb.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), jssj + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(t - r), Convert.ToString(r), oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + t - r;
                                                        //跨天分2条
                                                        TimeSpan ts1 = xb - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = et1 - xe;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        kssj = aaa.ToString("yyyy-MM-dd");
                                                        dayy = kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }
                                                    }

                                                }
                                                else
                                                {
                                                    x = x + t - r;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    DateTime bbb = Convert.ToDateTime(strDate).AddDays(i + 1);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string jssj = bbb.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveQJ(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), jssj + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(t - r), Convert.ToString(r), oaNo);
                                                    }
                                                }

                                            }

                                        }
                                    }

                                }
                            }
                            else
                            {
                                break;
                            }
                        }
                    }
                }

                double total = x;
                string z = Convert.ToString(total);
                return z;
            }
            catch (Exception ex)
            {
                ToolHelper.logger.Debug(ex.ToString());
                return Convert.ToString(0);
            }
        }
        /// <summary>
        /// 存储调休信息
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveTXTime(string time)
        {
            SaveLeaveTime leaveTime = new JavaScriptSerializer().Deserialize<SaveLeaveTime>(time);
            string manid = leaveTime.manid;
            string startTime = leaveTime.startTime;
            string endTime = leaveTime.endTime;
            string qjlx = leaveTime.qjlx;
            string oaNo = leaveTime.oaNo;
            string dptID = leaveTime.dptID;
            string type = leaveTime.type;
            try
            {
                DateTime start = Convert.ToDateTime(startTime);
                DateTime end = Convert.ToDateTime(endTime);
                DateTime ss = Convert.ToDateTime(start.ToString("yyyy-MM-dd"));
                DateTime ee = Convert.ToDateTime(end.ToString("yyyy-MM-dd"));
                TimeSpan ts = ee - ss;
                var day = Math.Ceiling((decimal)ts.TotalDays);
                double x = 0;
                OracleConnection conn = ToolHelper.OpenRavoerp(type);
                if (conn != null)
                {
                    //string sql = " select subcompanyid1 from hrmdepartment@ECOLOGY where id='" + dptID + "'";
                    //OracleCommand cmd = new OracleCommand(sql, conn);
                    //OracleDataAdapter da = new OracleDataAdapter(cmd);
                    //DataTable dt = new DataTable();
                    //da.Fill(dt);
                    //type = dt.Rows[0]["subcompanyid1"].ToString();
                    //ToolHelper.CloseSql(conn);
                    if (type != null)
                    {
                        for (int i = 0; i < day + 1; i++)
                        {
                            //conn = ToolHelper.OpenRavoerp(type);
                            string startday = start.AddDays(i).ToString("yyyyMMdd");
                            if (conn != null)
                            {
                                string sql = " select * from t_kqbc_dept where manid='" + manid + "' and dayid='" + startday + "' and state='4' ";
                                OracleCommand cmd = new OracleCommand(sql, conn);
                                OracleDataAdapter da = new OracleDataAdapter(cmd);
                                DataTable dt = new DataTable();
                                da.Fill(dt);
                                var num = dt.Rows.Count;
                                if (num == 0)
                                {
                                    ToolHelper.CloseSql(conn);
                                    x = x + 0;
                                }
                                else
                                {
                                    string bcid = dt.Rows[0]["BCID"].ToString();
                                    //string bcid = "18";
                                    sql = " select * from VH_LIST_KQBC where bcid='" + bcid + "' order by indexs ";
                                    cmd = new OracleCommand(sql, conn);
                                    da = new OracleDataAdapter(cmd);
                                    dt = new DataTable();
                                    da.Fill(dt);
                                    int n = dt.Rows.Count;
                                    if (n > 1)
                                    {
                                        if (n == 2)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string rests = dt.Rows[1]["RESTS"].ToString();
                                            string xbTime = dt.Rows[1]["XBTIME"].ToString();
                                            string xeTime = dt.Rows[1]["XETIME"].ToString();
                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            string strDate = start.ToString("yyyy-MM-dd");
                                            if (rests == "0")
                                            {
                                                if (i == 0)//第一天
                                                {
                                                    if (day == 0)//只有一天
                                                    {
                                                        if (ks <= bt1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - bt1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                //先判断是否要存储
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js < et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et1 - ks;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else if (i != day)//其中的第一天
                                                    {
                                                        if (ks <= bt1)
                                                        {
                                                            x = x + t1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            TimeSpan ts1 = et1 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            x = x + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                }
                                                else if (i == day)//最后一天
                                                {
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        TimeSpan ts1 = js - bt2;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t1;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        TimeSpan ts1 = js - bt1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else//当中几天
                                                {
                                                    x = x + t1 + t2;
                                                    string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                DateTime xb = Convert.ToDateTime(xbTime);
                                                DateTime xe = Convert.ToDateTime(xeTime);
                                                double t = Convert.ToDouble(times2);
                                                double r = Convert.ToDouble(rests);
                                                if (i == 0) //第一天
                                                {
                                                    if (bt1 < et2) //不跨天
                                                    {
                                                        if (day == 0) //请假开始结束都在同一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                if (js <= et1)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                    //先判断是否要存储
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (js >= bt2)
                                                                {
                                                                    if (js <= xb)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                        }
                                                                    }
                                                                    else if (js >= xe)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2 - r;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2 - r), "0", oaNo);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                        }
                                                                    }

                                                                }

                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if (xe >= js && js >= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks <= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks >= xe)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (i != day) //请假有n天,只是其中的第一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t2 - r), rests, oaNo);
                                                                }
                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t2 - r), rests, oaNo);
                                                                }
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if (xe >= ks && ks >= xb)
                                                                {
                                                                    TimeSpan ts1 = et2 - xe;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks <= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else //跨天 
                                                    {

                                                    }
                                                }
                                                else if (i == day) //最后一天
                                                {
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1 - r;
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                        }
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        if (js >= xe)
                                                        {
                                                            TimeSpan ts1 = js - xe;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = xb - bt2;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2 + t1;
                                                            string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2 + t1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (xe >= js && js >= xb)
                                                            {
                                                                TimeSpan ts1 = xb - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        x = x + 0;
                                                        //TimeSpan ts1 = js - bt1;
                                                        //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        //x = x + d1;
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else //当中几天
                                                {
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    x = x + t1 + t2 - r;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                    }
                                                }
                                            }
                                        }
                                        else if (n == 3)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string bTime3 = dt.Rows[2]["BTIME"].ToString();
                                            string eTime3 = dt.Rows[2]["ETIME"].ToString();
                                            string times3 = dt.Rows[2]["TIMES"].ToString();
                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            DateTime bt3 = Convert.ToDateTime(bTime3);
                                            DateTime et3 = Convert.ToDateTime(eTime3);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            double t3 = Convert.ToDouble(times3);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            string strDate = start.ToString("yyyy-MM-dd");
                                            if (i == 0)//第一天
                                            {
                                                if (day == 0)//只有一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - bt1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            //先判断是否要存储
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }

                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }

                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }

                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        if (js <= et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }

                                                        }
                                                        else if (js <= bt3)
                                                        {
                                                            x = x + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        if (js <= bt3)
                                                        {
                                                            x = x + 0;
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = js - bt3;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else if (i != day)//其中的第一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        x = x + t1 + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        TimeSpan ts1 = et1 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        x = x + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        TimeSpan ts1 = et2 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        x = x + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = et3 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                            }
                                            else if (i == day)//最后一天
                                            {
                                                if (js >= et3)
                                                {
                                                    x = x + t1 + t2 + t3;
                                                    string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                    dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= bt3)
                                                {
                                                    TimeSpan ts1 = js - bt3;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t2 + t1;
                                                    string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                    dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= et2)
                                                {
                                                    x = x + t2 + t1;
                                                    string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= bt2)
                                                {
                                                    TimeSpan ts1 = js - bt2;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t1;
                                                    string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= et1)
                                                {
                                                    x = x + t1;
                                                    string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                }
                                                else if (js > bt1)
                                                {
                                                    TimeSpan ts1 = js - bt1;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1;
                                                    string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else
                                                {
                                                    x = x + 0;
                                                }
                                            }
                                            else//当中几天
                                            {
                                                x = x + t1 + t2 + t3;
                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                }
                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                }
                                                dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                }
                                            }
                                        }
                                    }
                                    //一个排班分多个段
                                    else if (n == 1)
                                    {
                                        string bTime = dt.Rows[0]["BTIME"].ToString();
                                        string eTime = dt.Rows[0]["ETIME"].ToString();
                                        string times = dt.Rows[0]["TIMES"].ToString();
                                        string rests = dt.Rows[0]["RESTS"].ToString();
                                        string xbTime = dt.Rows[0]["XBTIME"].ToString();
                                        string xeTime = dt.Rows[0]["XETIME"].ToString();
                                        ToolHelper.CloseSql(conn);
                                        DateTime bt = Convert.ToDateTime(bTime);
                                        DateTime et = Convert.ToDateTime(eTime);
                                        DateTime xb = Convert.ToDateTime(xbTime);
                                        DateTime xe = Convert.ToDateTime(xeTime);
                                        double t = Convert.ToDouble(times);
                                        double r = Convert.ToDouble(rests);
                                        DateTime st1 = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                        DateTime et1 = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                        string strDate = start.ToString("yyyy-MM-dd");
                                        DateTime startDate = Convert.ToDateTime(strDate);
                                        //先判断是否是第一天还是最后一天 先不考虑分段排班情况
                                        if (i == 0)
                                        {

                                            if (bt < et)//不跨天
                                            {
                                                if (day == 0)//请假开始结束都在同一天
                                                {
                                                    if (st1 >= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            //先判断是否要存储
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = et1 - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 >= bt && et1 >= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                }
                                                else if (i != day)//请假有n天,只是其中的第一天
                                                {
                                                    if (st1 >= bt)
                                                    {
                                                        if (st1 >= et)
                                                        {
                                                            x = x + 0;
                                                        }
                                                        else
                                                        {
                                                            if (st1 <= xb)
                                                            {
                                                                TimeSpan ts1 = xb - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                                }
                                                            }
                                                            else if (st1 >= xb && st1 >= xe)
                                                            {
                                                                TimeSpan ts1 = et - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + 0;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (bt <= xb)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (bt >= xb && bt >= xe)
                                                        {
                                                            TimeSpan ts1 = et - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }

                                                    }

                                                }
                                            }
                                            else if (bt > et)//跨天
                                            {
                                                if (day == 0)//只有一天
                                                {
                                                    if (st1 >= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 >= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = et - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = xb - bt;
                                                        double d2 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + d2;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                }
                                                else if (i != day)
                                                {
                                                    if (st1 >= bt)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = et - xe;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                        x = x + d1 + d2;
                                                        //跨天分2条存储
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(1);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        dayy = kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;

                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else if (i == day)//最后一天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                //if (et1 >= et)
                                                //{
                                                //    TimeSpan ts1 = et - xe;
                                                //    double d1 = Math.Round((double)(t - r));
                                                //    x = x + d1;
                                                //    string kssj = Convert.ToString(Convert.ToDateTime(strDate).AddDays(i));
                                                //    OracleManager.Instance.OpenDb();
                                                //    OracleManager.Instance.CallProcTX(manid, qjlx, kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                //    OracleManager.Instance.CloseDb();
                                                //}
                                                //else
                                                //{
                                                if (et1 <= bt)
                                                {
                                                    x = x + 0;
                                                }
                                                else
                                                {
                                                    if (et1 >= xb && et1 >= xe)
                                                    {
                                                        TimeSpan ts1 = xb - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = et1 - xe;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                        x = x + d1 + d2;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                        }
                                                    }
                                                    else if (et1 >= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = xb - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (et1 <= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (et1 <= xb && et1 >= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                }
                                                //}
                                            }
                                            else if (bt > et)//跨天 weiwancheng
                                            {
                                                if (et1 <= et)
                                                {
                                                    TimeSpan ts1 = et - et1;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    double s = (x - d1);
                                                    x = s;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else
                                                {
                                                    if (et1 >= et && et1 <= bt)
                                                    {
                                                        x = x + 0;
                                                    }
                                                    else
                                                    {
                                                        if (et1 <= xb && et1 >= xe)
                                                        {
                                                            if (et1 >= bt)
                                                            {
                                                                TimeSpan ts1 = et1 - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //et1 = et1.AddHours(24);
                                                                TimeSpan ts1 = xb - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                                TimeSpan ts2 = et1 - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                aaa = Convert.ToDateTime(strDate).AddDays(i + 1);
                                                                kssj = aaa.ToString("yyyy-MM-dd");
                                                                dayy = kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (et1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                            string kssj = aaa.ToString("yyyy-MM-dd");
                                                            string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else//n天当中的几天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                x = x + t - r;
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(t - r), rests, oaNo);
                                                }
                                            }
                                            else//跨天
                                            {
                                                x = x + t - r;
                                                //跨天分2条
                                                TimeSpan ts1 = xb - bt;
                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                TimeSpan ts2 = et - xe;
                                                double d2 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                }
                                                aaa = Convert.ToDateTime(strDate).AddDays(i + 1);
                                                kssj = aaa.ToString("yyyy-MM-dd");
                                                dayy = kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveTX(type, manid, qjlx, kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), kssj + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                }
                                            }

                                        }
                                    }

                                }
                            }
                            else
                            {
                                break;
                            }
                        }
                    }
                }

                double total = x;
                string z = Convert.ToString(total);
                return z;
            }
            catch (Exception ex)
            {
                ToolHelper.logger.Debug(ex.ToString());
                return Convert.ToString(0);
            }
        }
        /// <summary>
        /// 存储出差信息
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveCCTime(string time)
        {

            string qjlx = "1";
            SaveCCTime ccTime = new JavaScriptSerializer().Deserialize<SaveCCTime>(time);
            string ccr = ccTime.ccr;//需先转换为考勤编号再使用
            string startTime = ccTime.startTime;
            string endTime = ccTime.endTime;
            string oaNo = ccTime.oaNo;
            double total = 0;
            string dptID = ccTime.dptID;
            string type = ccTime.type;
            try
            {
                DateTime start = Convert.ToDateTime(startTime);
                DateTime end = Convert.ToDateTime(endTime);
                DateTime ss = Convert.ToDateTime(start.ToString("yyyy-MM-dd"));
                DateTime ee = Convert.ToDateTime(end.ToString("yyyy-MM-dd"));
                TimeSpan ts = ee - ss;
                var day = Math.Ceiling((decimal)ts.TotalDays);
                double x = 0;
                OracleConnection conn = ToolHelper.OpenRavoerp("oa");
                if (conn != null)
                {
                    //string sql = " select subcompanyid1 from hrmdepartment@ECOLOGY where id='" + dptID + "'";
                    //OracleCommand cmd = new OracleCommand(sql, conn);
                    //OracleDataAdapter da = new OracleDataAdapter(cmd);
                    //DataTable dt = new DataTable();
                    //da.Fill(dt);
                    //type = dt.Rows[0]["subcompanyid1"].ToString();
                    //ToolHelper.CloseSql(conn);
                    ////查找考勤编号
                    //conn = ToolHelper.OpenRavoerp("oa");
                    string sql = " select loginid,subcompanyid1 from HrmResource where id=" + ccr;
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    string manid = dt.Rows[0]["loginid"].ToString();
                    //type= dt.Rows[0]["subcompanyid1"].ToString();
                    if (type != null)
                    {
                        for (int i = 0; i < day + 1; i++)
                        {
                            conn = ToolHelper.OpenRavoerp(type);

                            string startday = start.AddDays(i).ToString("yyyyMMdd");
                            if (conn != null)
                            {
                                sql = " select * from t_kqbc_dept where manid='" + manid + "' and dayid='" + startday + "' and state='4' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                var num = dt.Rows.Count;
                                if (num == 0)
                                {
                                    ToolHelper.CloseSql(conn);
                                    x = x + 0;
                                }
                                else
                                {
                                    string bcid = dt.Rows[0]["BCID"].ToString();
                                    //string bcid = "18";
                                    sql = " select * from VH_LIST_KQBC where bcid='" + bcid + "' order by indexs ";
                                    cmd = new OracleCommand(sql, conn);
                                    da = new OracleDataAdapter(cmd);
                                    dt = new DataTable();
                                    da.Fill(dt);
                                    int n = dt.Rows.Count;
                                    if (n > 1)
                                    {
                                        if (n == 2)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string rests = dt.Rows[1]["RESTS"].ToString();
                                            string xbTime = dt.Rows[1]["XBTIME"].ToString();
                                            string xeTime = dt.Rows[1]["XETIME"].ToString();
                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            string strDate = start.ToString("yyyy-MM-dd");
                                            if (rests == "0")
                                            {
                                                if (i == 0)//第一天
                                                {
                                                    if (day == 0)//只有一天
                                                    {

                                                        if (ks <= bt1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - bt1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                //先判断是否要存储
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js < et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            if (js <= et1)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= bt2)
                                                            {
                                                                x = x + t1;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et1 - ks;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }

                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                                }
                                                                dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            if (js <= et2)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                //修复错误dayy错误 19/12/05
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t2;
                                                                string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else if (i != day)//其中的第一天
                                                    {
                                                        if (ks <= bt1)
                                                        {
                                                            x = x + t1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= et1)
                                                        {
                                                            TimeSpan ts1 = et1 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= bt2)
                                                        {
                                                            x = x + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (ks <= et2)
                                                        {
                                                            TimeSpan ts1 = et2 - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                }
                                                else if (i == day)//最后一天
                                                {
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        TimeSpan ts1 = js - bt2;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        TimeSpan ts1 = js - bt1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else//当中几天
                                                {
                                                    x = x + t1 + t2;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "' ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                DateTime xb = Convert.ToDateTime(xbTime);
                                                DateTime xe = Convert.ToDateTime(xeTime);
                                                double t = Convert.ToDouble(times2);
                                                double r = Convert.ToDouble(rests);
                                                if (i == 0) //第一天
                                                {
                                                    if (bt1 < et2) //不跨天
                                                    {
                                                        if (day == 0) //请假开始结束都在同一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                if (js <= et1)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                    //先判断是否要存储
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (js >= bt2)
                                                                {
                                                                    if (js <= xb)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                        }
                                                                    }
                                                                    else if (js >= xe)
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2 - r;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2 - r), "0", oaNo);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        TimeSpan ts1 = et1 - ks;
                                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                        TimeSpan ts2 = js - bt2;
                                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                        x = x + d1 + d2;
                                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                        conn = ToolHelper.OpenRavoerp(type);
                                                                        cmd = new OracleCommand(sql, conn);
                                                                        da = new OracleDataAdapter(cmd);
                                                                        dt = new DataTable();
                                                                        da.Fill(dt);
                                                                        num = dt.Rows.Count;
                                                                        ToolHelper.CloseSql(conn);
                                                                        if (num == 0)
                                                                        {
                                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                        }
                                                                    }

                                                                }

                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = js - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if (xe >= js && js >= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks <= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks >= xe)
                                                                {
                                                                    TimeSpan ts1 = js - ks;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + t1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1 + t2 - r), "0", oaNo);
                                                                }
                                                            }
                                                        }
                                                        else if (i != day) //请假有n天,只是其中的第一天
                                                        {
                                                            if (ks <= et1)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t2 - r), rests, oaNo);
                                                                }
                                                            }
                                                            else if (ks <= bt2)
                                                            {
                                                                TimeSpan ts1 = et1 - ks;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 1);
                                                                x = x + d1 + t2 - r;
                                                                string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t2 - r), rests, oaNo);
                                                                }
                                                            }
                                                            else if (ks <= et2)
                                                            {
                                                                if (xe >= ks && ks >= xb)
                                                                {
                                                                    TimeSpan ts1 = et2 - xe;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                                    }
                                                                }
                                                                else if (ks <= xb)
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    x = x + d1 + t1;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    TimeSpan ts1 = xb - bt2;
                                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                    TimeSpan ts2 = js - xe;
                                                                    double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                    x = x + d1 + d2;
                                                                    string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                    conn = ToolHelper.OpenRavoerp(type);
                                                                    cmd = new OracleCommand(sql, conn);
                                                                    da = new OracleDataAdapter(cmd);
                                                                    dt = new DataTable();
                                                                    da.Fill(dt);
                                                                    num = dt.Rows.Count;
                                                                    ToolHelper.CloseSql(conn);
                                                                    if (num == 0)
                                                                    {
                                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1 + d2), "0", oaNo);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else //跨天 
                                                    {

                                                    }
                                                }
                                                else if (i == day) //最后一天
                                                {
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    if (js >= et2)
                                                    {
                                                        x = x + t2 + t1 - r;
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                        }
                                                    }
                                                    else if (js >= bt2)
                                                    {
                                                        if (js >= xe)
                                                        {
                                                            TimeSpan ts1 = js - xe;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = xb - bt2;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2 + t1;
                                                            string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + d2 + t1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (xe >= js && js >= xb)
                                                            {
                                                                TimeSpan ts1 = xb - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                TimeSpan ts1 = js - bt2;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1 + t1;
                                                                string dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1 + t1), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                    }
                                                    else if (js >= et1)
                                                    {
                                                        x = x + t1;
                                                        string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (js > bt1)
                                                    {
                                                        x = x + 0;
                                                        //TimeSpan ts1 = js - bt1;
                                                        //double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        //x = x + d1;
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else //当中几天
                                                {
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    x = x + t1 + t2 - r;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t1 + t2 - r), rests, oaNo);
                                                    }
                                                }
                                            }
                                        }
                                        else if (n == 3)
                                        {
                                            string bTime1 = dt.Rows[0]["BTIME"].ToString();
                                            string eTime1 = dt.Rows[0]["ETIME"].ToString();
                                            string times1 = dt.Rows[0]["TIMES"].ToString();
                                            string bTime2 = dt.Rows[1]["BTIME"].ToString();
                                            string eTime2 = dt.Rows[1]["ETIME"].ToString();
                                            string times2 = dt.Rows[1]["TIMES"].ToString();
                                            string bTime3 = dt.Rows[2]["BTIME"].ToString();
                                            string eTime3 = dt.Rows[2]["ETIME"].ToString();
                                            string times3 = dt.Rows[2]["TIMES"].ToString();
                                            ToolHelper.CloseSql(conn);
                                            DateTime bt1 = Convert.ToDateTime(bTime1);
                                            DateTime et1 = Convert.ToDateTime(eTime1);
                                            DateTime bt2 = Convert.ToDateTime(bTime2);
                                            DateTime et2 = Convert.ToDateTime(eTime2);
                                            DateTime bt3 = Convert.ToDateTime(bTime3);
                                            DateTime et3 = Convert.ToDateTime(eTime3);
                                            double t1 = Convert.ToDouble(times1);
                                            double t2 = Convert.ToDouble(times2);
                                            double t3 = Convert.ToDouble(times3);
                                            DateTime ks = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                            DateTime js = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                            string strDate = start.ToString("yyyy-MM-dd");
                                            if (i == 0)//第一天
                                            {
                                                if (day == 0)//只有一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - bt1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            //先判断是否要存储
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='"+manid+"' ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }

                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }

                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        if (js <= et1)
                                                        {
                                                            TimeSpan ts1 = js - ks;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt2)
                                                        {
                                                            x = x + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t1;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }

                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t1 + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }

                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }

                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        if (js <= et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= bt3)
                                                        {
                                                            x = x + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1 + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        if (js < et2)
                                                        {
                                                            TimeSpan ts1 = js - bt2;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (js < bt3)
                                                        {
                                                            x = x + t2;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t2 + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                            }
                                                            dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        if (js <= bt3)
                                                        {
                                                            x = x + 0;
                                                        }
                                                        else if (js <= et3)
                                                        {
                                                            TimeSpan ts1 = js - bt3;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + t3;
                                                            string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = js - bt3;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                                else if (i != day)//其中的第一天
                                                {
                                                    if (ks <= bt1)
                                                    {
                                                        x = x + t1 + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et1)
                                                    {
                                                        TimeSpan ts1 = et1 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= bt2)
                                                    {
                                                        x = x + t2 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et2)
                                                    {
                                                        TimeSpan ts1 = et2 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + t3;
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= bt3)
                                                    {
                                                        x = x + t3;
                                                        string dayy = strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                        }
                                                    }
                                                    else if (ks <= et3)
                                                    {
                                                        TimeSpan ts1 = et3 - ks;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(ks.Hour) + ":" + Convert.ToString(ks.Minute), strDate + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        x = x + 0;
                                                    }
                                                }
                                            }
                                            else if (i == day)//最后一天
                                            {
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                if (js >= et3)
                                                {
                                                    x = x + t1 + t2 + t3;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), kssj + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= bt3)
                                                {
                                                    TimeSpan ts1 = js - bt3;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t2 + t1;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= et2)
                                                {
                                                    x = x + t2 + t1;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= bt2)
                                                {
                                                    TimeSpan ts1 = js - bt2;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1 + t1;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                    dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else if (js >= et1)
                                                {
                                                    x = x + t1;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                    }
                                                }
                                                else if (js > bt1)
                                                {
                                                    TimeSpan ts1 = js - bt1;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    x = x + d1;
                                                    string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(js.Hour) + ":" + Convert.ToString(js.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else
                                                {
                                                    x = x + 0;
                                                }
                                            }
                                            else//当中几天
                                            {
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                x = x + t1 + t2 + t3;
                                                string dayy = kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt1.Hour) + ":" + Convert.ToString(bt1.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(t1), "0", oaNo);
                                                }
                                                dayy = kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt2.Hour) + ":" + Convert.ToString(bt2.Minute), kssj + " " + Convert.ToString(et2.Hour) + ":" + Convert.ToString(et2.Minute), Convert.ToString(t2), "0", oaNo);
                                                }
                                                dayy = kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt3.Hour) + ":" + Convert.ToString(bt3.Minute), kssj + " " + Convert.ToString(et3.Hour) + ":" + Convert.ToString(et3.Minute), Convert.ToString(t3), "0", oaNo);
                                                }
                                            }
                                        }
                                    }
                                    //一个排班分多个段
                                    else if (n == 1)
                                    {
                                        string bTime = dt.Rows[0]["BTIME"].ToString();
                                        string eTime = dt.Rows[0]["ETIME"].ToString();
                                        string times = dt.Rows[0]["TIMES"].ToString();
                                        string rests = dt.Rows[0]["RESTS"].ToString();
                                        string xbTime = dt.Rows[0]["XBTIME"].ToString();
                                        string xeTime = dt.Rows[0]["XETIME"].ToString();
                                        ToolHelper.CloseSql(conn);
                                        DateTime bt = Convert.ToDateTime(bTime);
                                        DateTime et = Convert.ToDateTime(eTime);
                                        DateTime xb = Convert.ToDateTime(xbTime);
                                        DateTime xe = Convert.ToDateTime(xeTime);
                                        double t = Convert.ToDouble(times);
                                        double r = Convert.ToDouble(rests);
                                        DateTime st1 = Convert.ToDateTime(start.Hour + ":" + start.Minute);//请假开始时间
                                        DateTime et1 = Convert.ToDateTime(end.Hour + ":" + end.Minute);
                                        string strDate = start.ToString("yyyy-MM-dd");
                                        DateTime startDate = Convert.ToDateTime(strDate);
                                        //先判断是否是第一天还是最后一天 先不考虑分段排班情况
                                        if (i == 0)
                                        {

                                            if (bt < et)//不跨天
                                            {
                                                if (day == 0)//请假开始结束都在同一天
                                                {
                                                    if (st1 >= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            //先判断是否要存储
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = et1 - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 >= bt && et1 >= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 <= et)
                                                    {
                                                        if (st1 <= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (st1 <= xb && et1 <= xe)
                                                        {
                                                            TimeSpan ts1 = xb - st1;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else if (st1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts2 = et1 - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d2;
                                                            string dayy = strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }
                                                    }
                                                }
                                                else if (i != day)//请假有n天,只是其中的第一天
                                                {
                                                    if (st1 >= bt)
                                                    {
                                                        if (st1 >= et)
                                                        {
                                                            x = x + 0;
                                                        }
                                                        else
                                                        {
                                                            if (st1 <= xb)
                                                            {
                                                                TimeSpan ts1 = xb - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                TimeSpan ts2 = et - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                                }
                                                            }
                                                            else if (st1 >= xb && st1 >= xe)
                                                            {
                                                                TimeSpan ts1 = et - st1;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                x = x + 0;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (bt <= xb)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            TimeSpan ts2 = et - xe;
                                                            double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                            x = x + d1 + d2;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                            }
                                                        }
                                                        else if (bt >= xb && bt >= xe)
                                                        {
                                                            TimeSpan ts1 = et - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            string dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            x = x + 0;
                                                        }

                                                    }

                                                }
                                            }
                                            else if (bt > et)//跨天
                                            {
                                                if (day == 0)//只有一天
                                                {
                                                    if (st1 >= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 >= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 >= xb)
                                                    {
                                                        TimeSpan ts1 = et - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = xb - bt;
                                                        double d2 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1 + d2;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        dayy = strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }
                                                    }
                                                    else if (st1 <= bt && et1 <= xb)
                                                    {
                                                        TimeSpan ts1 = et1 - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }

                                                    }
                                                }
                                                else if (i != day)
                                                {
                                                    if (st1 >= bt)
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = et - xe;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                        x = x + d1 + d2;
                                                        //跨天分2条存储
                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(1);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        dayy = kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        TimeSpan ts1 = xb - st1;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;

                                                        string dayy = strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, strDate + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else if (i == day)//最后一天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                //if (et1 >= et)
                                                //{
                                                //    TimeSpan ts1 = et - xe;
                                                //    double d1 = Math.Round((double)(t - r));
                                                //    x = x + d1;
                                                //    string kssj = Convert.ToString(Convert.ToDateTime(strDate).AddDays(i));
                                                //    OracleManager.Instance.OpenDb();
                                                //    OracleManager.Instance.CallProcCC(manid, qjlx, kssj + " " + Convert.ToString(st1.Hour) + ":" + Convert.ToString(st1.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                //    OracleManager.Instance.CloseDb();
                                                //}
                                                //else
                                                //{
                                                if (et1 <= bt)
                                                {
                                                    x = x + 0;
                                                }
                                                else
                                                {
                                                    if (et1 >= xb && et1 >= xe)
                                                    {
                                                        TimeSpan ts1 = xb - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        TimeSpan ts2 = et1 - xe;
                                                        double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                        x = x + d1 + d2;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1 + d2), rests, oaNo);
                                                        }
                                                    }
                                                    else if (et1 >= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = xb - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (et1 <= xb && et1 <= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                    else if (et1 <= xb && et1 >= xe)
                                                    {
                                                        TimeSpan ts1 = et1 - bt;
                                                        double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                        x = x + d1;
                                                        DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                        string kssj = aaa.ToString("yyyy-MM-dd");
                                                        string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                        sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                        conn = ToolHelper.OpenRavoerp(type);
                                                        cmd = new OracleCommand(sql, conn);
                                                        da = new OracleDataAdapter(cmd);
                                                        dt = new DataTable();
                                                        da.Fill(dt);
                                                        num = dt.Rows.Count;
                                                        ToolHelper.CloseSql(conn);
                                                        if (num == 0)
                                                        {
                                                            SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                        }
                                                    }
                                                }
                                                //}
                                            }
                                            else if (bt > et)//跨天 weiwancheng
                                            {
                                                if (et1 <= et)
                                                {
                                                    TimeSpan ts1 = et - et1;
                                                    double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                    double s = (x - d1);
                                                    x = s;
                                                    DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                    string kssj = aaa.ToString("yyyy-MM-dd");
                                                    string dayy = kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute);
                                                    sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                    conn = ToolHelper.OpenRavoerp(type);
                                                    cmd = new OracleCommand(sql, conn);
                                                    da = new OracleDataAdapter(cmd);
                                                    dt = new DataTable();
                                                    da.Fill(dt);
                                                    num = dt.Rows.Count;
                                                    ToolHelper.CloseSql(conn);
                                                    if (num == 0)
                                                    {
                                                        SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), strDate + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d1), "0", oaNo);
                                                    }
                                                }
                                                else
                                                {
                                                    if (et1 >= et && et1 <= bt)
                                                    {
                                                        x = x + 0;
                                                    }
                                                    else
                                                    {
                                                        if (et1 <= xb && et1 >= xe)
                                                        {
                                                            if (et1 >= bt)
                                                            {
                                                                TimeSpan ts1 = et1 - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                x = x + d1;
                                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //et1 = et1.AddHours(24);
                                                                TimeSpan ts1 = xb - bt;
                                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                                }

                                                                TimeSpan ts2 = et1 - xe;
                                                                double d2 = Math.Round((double)(ts2.Hours * 60 + ts2.Minutes) / 60, 2);
                                                                x = x + d1 + d2;
                                                                aaa = Convert.ToDateTime(strDate).AddDays(i + 1);
                                                                kssj = aaa.ToString("yyyy-MM-dd");
                                                                dayy = kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                                conn = ToolHelper.OpenRavoerp(type);
                                                                cmd = new OracleCommand(sql, conn);
                                                                da = new OracleDataAdapter(cmd);
                                                                dt = new DataTable();
                                                                da.Fill(dt);
                                                                num = dt.Rows.Count;
                                                                ToolHelper.CloseSql(conn);
                                                                if (num == 0)
                                                                {
                                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), strDate + " " + Convert.ToString(et1.Hour) + ":" + Convert.ToString(et1.Minute), Convert.ToString(d2), "0", oaNo);
                                                                }
                                                            }

                                                        }
                                                        else if (et1 >= xb && et1 >= xe)
                                                        {
                                                            TimeSpan ts1 = xb - bt;
                                                            double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                            x = x + d1;
                                                            DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                            string kssj = aaa.ToString("yyyy-MM-dd");
                                                            string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                            sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                            conn = ToolHelper.OpenRavoerp(type);
                                                            cmd = new OracleCommand(sql, conn);
                                                            da = new OracleDataAdapter(cmd);
                                                            dt = new DataTable();
                                                            da.Fill(dt);
                                                            num = dt.Rows.Count;
                                                            ToolHelper.CloseSql(conn);
                                                            if (num == 0)
                                                            {
                                                                SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), strDate + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                x = x + 0;
                                            }
                                        }
                                        else//n天当中的几天
                                        {
                                            if (bt < et)//不跨天
                                            {
                                                x = x + t - r;
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(t - r), rests, oaNo);
                                                }
                                            }
                                            else//跨天
                                            {
                                                x = x + t - r;
                                                //跨天分2条
                                                TimeSpan ts1 = xb - bt;
                                                double d1 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                TimeSpan ts2 = et - xe;
                                                double d2 = Math.Round((double)(ts1.Hours * 60 + ts1.Minutes) / 60, 2);
                                                DateTime aaa = Convert.ToDateTime(strDate).AddDays(i);
                                                string kssj = aaa.ToString("yyyy-MM-dd");
                                                string dayy = kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(bt.Hour) + ":" + Convert.ToString(bt.Minute), kssj + " " + Convert.ToString(xb.Hour) + ":" + Convert.ToString(xb.Minute), Convert.ToString(d1), "0", oaNo);
                                                }
                                                aaa = Convert.ToDateTime(strDate).AddDays(i + 1);
                                                kssj = aaa.ToString("yyyy-MM-dd");
                                                dayy = kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute);
                                                sql = " select * from ask_leave where oano='" + oaNo + "' and leaveday=to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss') and man_id='" + manid + "'  ";
                                                conn = ToolHelper.OpenRavoerp(type);
                                                cmd = new OracleCommand(sql, conn);
                                                da = new OracleDataAdapter(cmd);
                                                dt = new DataTable();
                                                da.Fill(dt);
                                                num = dt.Rows.Count;
                                                ToolHelper.CloseSql(conn);
                                                if (num == 0)
                                                {
                                                    SqlSaveHelper.SaveCC(type, manid, qjlx, kssj + " " + Convert.ToString(xe.Hour) + ":" + Convert.ToString(xe.Minute), kssj + " " + Convert.ToString(et.Hour) + ":" + Convert.ToString(et.Minute), Convert.ToString(d2), "0", oaNo);
                                                }
                                            }

                                        }
                                    }

                                }
                            }
                            else
                            {
                                break;
                            }
                        }
                    }
                }

                total = x;
                string z = Convert.ToString(total);
                return z;
            }
            catch (Exception ex)
            {
                ToolHelper.logger.Debug(ex.ToString());
                return Convert.ToString(0);
            }
        }
        /// <summary>
        /// 存储加班单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveOTTime(string time)
        {
            //string json = "{\"manid\":\"2049605\",\"startTime\":\"2019-06-17 18:00\",\"endTime\":\"2019-06-17 20:00\",\"rest\":\"1.00\",\"oaNo\":\"R2-JBSQD2019070236\"}";
            try
            {
                OTInfo ot = new JavaScriptSerializer().Deserialize<OTInfo>(time);
                string dptID = ot.dptID;
                DateTime start = Convert.ToDateTime(ot.startTime);
                DateTime end = Convert.ToDateTime(ot.endTime);
                string s = start.ToString("T");
                string e1 = end.ToString("T");
                DateTime ss = Convert.ToDateTime(s);
                DateTime ee = Convert.ToDateTime(e1);
                string type = "";
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    string sql = " select subcompanyid1 from hrmdepartment@ECOLOGY where id='" + dptID + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    type = dt.Rows[0]["subcompanyid1"].ToString();
                    ToolHelper.CloseSql(conn);
                    if (type != null)
                    {
                        if (ee >= ss)
                        {
                            //不跨天
                            TimeSpan ts = ee - ss;
                            double d = Math.Round((double)(ts.Hours * 60 + ts.Minutes) / 60, 2);
                            double t = d - Convert.ToDouble(ot.rest);
                            string times = Convert.ToString(t);
                            conn = ToolHelper.OpenRavoerp(type);
                            if (conn != null)
                            {
                                //查询是否在数据库里存在
                                sql = " select * from t_kqdxcard where oano='" + ot.oaNo + "' and fbday=to_date('" + ot.startTime + "','yyyy-mm-dd hh24:mi:ss') and fempid='" + ot.manid + "' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                var num = dt.Rows.Count;
                                ToolHelper.CloseSql(conn);
                                if (num == 0)
                                {
                                    SqlSaveHelper.SaveOT(type, ot.manid, ot.startTime, ot.endTime, ot.oaNo, times, ot.rest);
                                }
                            }
                        }
                        else
                        {
                            //跨天 开始时间 结束时间
                            string sday = start.ToString("yyyy-MM-dd");
                            string eday = end.ToString("yyyy-MM-dd");

                            DateTime zero = Convert.ToDateTime("1970-01-01 00:00:00");
                            DateTime ze = Convert.ToDateTime(sday + " 23:59:59");
                            TimeSpan ts = ze - start;
                            double d = Math.Round((double)(ts.Hours * 60 + ts.Minutes) / 60, 1);
                            double t = d - Convert.ToDouble(ot.rest);
                            string times = Convert.ToString(t);
                            conn = ToolHelper.OpenRavoerp(type);
                            if (conn != null)
                            {
                                //查询是否在数据库里存在
                                sql = " select * from t_kqdxcard where oano='" + ot.oaNo + "' and fbday=to_date('" + ot.startTime + "','yyyy-mm-dd hh24:mi:ss') and fempid='" + ot.manid + "' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                var num = dt.Rows.Count;
                                ToolHelper.CloseSql(conn);
                                if (num == 0)
                                {
                                    SqlSaveHelper.SaveOT(type, ot.manid, ot.startTime, sday + " 23:59:59", ot.oaNo, times, ot.rest);
                                }
                            }
                            string eeday = eday + " 00:00:00";
                            DateTime eDataTime = Convert.ToDateTime(eeday);
                            ts = ee - zero;
                            d = Math.Round((double)(ts.Hours * 60 + ts.Minutes) / 60, 2);
                            t = d - Convert.ToDouble(ot.rest);
                            times = Convert.ToString(t);
                            conn = ToolHelper.OpenRavoerp(type);
                            if (conn != null)
                            {
                                //查询是否在数据库里存在
                                sql = " select * from t_kqdxcard where oano='" + ot.oaNo + "' and fbday=to_date('" + eDataTime + "','yyyy-mm-dd hh24:mi:ss') and fempid='" + ot.manid + "' ";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                var num = dt.Rows.Count;
                                ToolHelper.CloseSql(conn);
                                if (num == 0)
                                {
                                    SqlSaveHelper.SaveOT(type, ot.manid, eDataTime.ToString("yyyy-MM-dd HH:mm:ss"), ot.endTime, ot.oaNo, times, ot.rest);
                                }
                            }
                        }
                    }
                    return "";
                }
                return "";

            }
            catch (Exception ex)
            {

                throw;
            }
        }
        #endregion

        /// <summary>
        /// 存储补助申请单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBZ(string time)
        {
            try
            {
                BZInfo bz = new JavaScriptSerializer().Deserialize<BZInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("141");
                if (conn != null)
                {
                    string bzny = bz.xzny.Substring(0, bz.xzny.Length -3);
                    //先判断是否存在
                    string sql = " select * from MAN_YCXZLR where manid='"+ bz.manid + "' and  oano='"+bz.oano+"'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //添加
                        conn = ToolHelper.OpenRavoerp("141");
                        sql = " INSERT INTO MAN_YCXZLR(MANID,XZXM, XZNY, TDRQ ,JS,AMTN,FS_NO, C_USER,E_USER,REM,OANO) VALUES('" + bz.manid + "', 'A12', '" + bzny + "', SYSDATE, '" + bz.wbzje + "', 0, NULL, 1, 1, 'OA同步','"+bz.oano+"') ";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                return "";
            }
        }
        #region 办公用品
        /// <summary>
        /// 办公用品请购单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveQGBG(string time)
        {
            try
            {
                ToolHelper.logger.Debug("message" + time);
                QGInfo qg = new JavaScriptSerializer().Deserialize<QGInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from PUR_REQBILL where oano='" + qg.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取fno和fid
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select fno from PUR_REQBILL order by fno desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fnos = dt.Rows[0]["FNO"].ToString();//QG20-0045
                        string a = fnos.Substring(5);//0045
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(4, '0');
                        string d = fnos.Substring(0, fnos.Length - 4);
                        string fno = d + c;

                        string department = "00";
                        string name = "系统管理员";
                        string idCode = "1";
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " INSERT INTO PUR_REQBILL(WRITE_DAY,LIFE_CODE, RE_MARK, SYS_USER ,DEPARTMENT,CHECKMAN,CHECKDAY,FNO,FID,SQ_DD,SAL_NO,BIL_TYPE,EST_DD,CLS_ID,OANO) " +
                            " VALUES(to_date('" + qg.sqrq + "','yyyy-mm-dd hh24:mi:ss'),4,'" + qg.remark + "','" + idCode + "','" + department + "','2770',to_date('" + qg.qrrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "'," +
                            "'" + fid + "',to_date('" + qg.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'" + name + "',9,to_date('" + qg.yjrq + "','yyyy-mm-dd hh24:mi:ss'),'F','" + qg.oano + "') ";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from PUR_REQBILL_DETAIL where oano='" + qg.oano + "' and productid ='" + qg.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = qg.xh + 1;
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO PUR_REQBILL_DETAIL(INDEX_CODE,PRODUCTID,NEEDMANY,LIFE_CODE,RE_MARK,NEEDDAY,FNO,TEMPINQTY,FID,INQTY,OANO) " +
                                " VALUES('" + xh1 + "','" + qg.wlbh + "','" + qg.xqsl + "',4,'" + qg.bz + "',to_date('" + qg.yhrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "',0,'" + fid + "',0,'" + qg.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //在oa数据库中添加 采购单号和序号
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.* from FORMTABLE_MAIN_330 A left join FORMTABLE_MAIN_330_DT1 B on A.id = B.mainid where qgdh='"+ qg.oano + "' and bh='" + qg.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string oaid = dt.Rows[0]["ID"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set xh='"+xh1+"' ,cgdh = '"+ fno + "' where id='"+oaid+"'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                        }
                        return "1";
                    }
                    else
                    {
                        string fno = dt.Rows[0]["FNO"].ToString();
                        string id = dt.Rows[0]["FID"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from PUR_REQBILL_DETAIL where oano='" + qg.oano + "' and productid ='" + qg.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = qg.xh + 1;
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO PUR_REQBILL_DETAIL(INDEX_CODE,PRODUCTID,NEEDMANY,LIFE_CODE,RE_MARK,NEEDDAY,FNO,TEMPINQTY,FID,INQTY,OANO) " +
                                " VALUES('" + xh1 + "','" + qg.wlbh + "','" + qg.xqsl + "',4,'" + qg.bz + "',to_date('" + qg.yhrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "',0,'" + id + "',0,'" + qg.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //在oa数据库中添加 采购单号和序号
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.* from FORMTABLE_MAIN_330 A left join FORMTABLE_MAIN_330_DT1 B on A.id = B.mainid where qgdh='" + qg.oano + "' and bh='" + qg.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string oaid = dt.Rows[0]["ID"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set xh='" + xh1 + "' ,cgdh = '" + fno + "' where id='" + oaid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 实业办公用品请购单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveQGBG1(string time)
        {
            try
            {
                QGInfo qg = new JavaScriptSerializer().Deserialize<QGInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("21");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from PUR_REQBILL where oano='" + qg.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取fno和fid
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select fno from PUR_REQBILL order by fno desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fnos = dt.Rows[0]["FNO"].ToString();//QG20-0045
                        string a = fnos.Substring(5);//0045
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(4, '0');
                        string d = fnos.Substring(0, fnos.Length - 4);
                        string fno = d + c;

                        string department = "00";
                        string name = "系统管理员";
                        string idCode = "1";
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " INSERT INTO PUR_REQBILL(WRITE_DAY,LIFE_CODE, RE_MARK, SYS_USER ,DEPARTMENT,CHECKMAN,CHECKDAY,FNO,FID,SQ_DD,SAL_NO,BIL_TYPE,EST_DD,CLS_ID,OANO) " +
                            " VALUES(to_date('" + qg.sqrq + "','yyyy-mm-dd hh24:mi:ss'),4,'" + qg.remark + "','" + idCode + "','" + department + "','2770',to_date('" + qg.qrrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "'," +
                            "'" + fid + "',to_date('" + qg.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'" + name + "',9,to_date('" + qg.yjrq + "','yyyy-mm-dd hh24:mi:ss'),'F','" + qg.oano + "') ";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from PUR_REQBILL_DETAIL where oano='" + qg.oano + "' and productid ='" + qg.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = qg.xh + 1;
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO PUR_REQBILL_DETAIL(INDEX_CODE,PRODUCTID,NEEDMANY,LIFE_CODE,RE_MARK,NEEDDAY,FNO,TEMPINQTY,FID,INQTY,OANO) " +
                                " VALUES('" + xh1 + "','" + qg.wlbh + "','" + qg.xqsl + "',4,'" + qg.bz + "',to_date('" + qg.yhrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "',0,'" + fid + "',0,'" + qg.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //在oa数据库中添加 采购单号和序号
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.* from FORMTABLE_MAIN_330 A left join FORMTABLE_MAIN_330_DT1 B on A.id = B.mainid where qgdh='" + qg.oano + "' and bh1='" + qg.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string oaid = dt.Rows[0]["ID"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set xh='" + xh1 + "' ,cgdh = '" + fno + "' where id='" + oaid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                        }
                        return "1";
                    }
                    else
                    {
                        string fno = dt.Rows[0]["FNO"].ToString();
                        string id = dt.Rows[0]["FID"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from PUR_REQBILL_DETAIL where oano='" + qg.oano + "' and productid ='" + qg.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = qg.xh + 1;
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO PUR_REQBILL_DETAIL(INDEX_CODE,PRODUCTID,NEEDMANY,LIFE_CODE,RE_MARK,NEEDDAY,FNO,TEMPINQTY,FID,INQTY,OANO) " +
                                " VALUES('" + xh1 + "','" + qg.wlbh + "','" + qg.xqsl + "',4,'" + qg.bz + "',to_date('" + qg.yhrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "',0,'" + id + "',0,'" + qg.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //在oa数据库中添加 采购单号和序号
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.* from FORMTABLE_MAIN_330 A left join FORMTABLE_MAIN_330_DT1 B on A.id = B.mainid where qgdh='" + qg.oano + "' and bh1='" + qg.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string oaid = dt.Rows[0]["ID"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set xh='" + xh1 + "' ,cgdh = '" + fno + "' where id='" + oaid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 五厂办公用品请购单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveQGBG5(string time)
        {
            try
            {
                QGInfo qg = new JavaScriptSerializer().Deserialize<QGInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("22");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from PUR_REQBILL where oano='" + qg.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取fno和fid
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select fno from PUR_REQBILL order by fno desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fnos = dt.Rows[0]["FNO"].ToString();//QG20-0045
                        string a = fnos.Substring(5);//0045
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(4, '0');
                        string d = fnos.Substring(0, fnos.Length - 4);
                        string fno = d + c;

                        string department = "00";
                        string name = "系统管理员";
                        string idCode = "1";
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " INSERT INTO PUR_REQBILL(WRITE_DAY,LIFE_CODE, RE_MARK, SYS_USER ,DEPARTMENT,CHECKMAN,CHECKDAY,FNO,FID,SQ_DD,SAL_NO,BIL_TYPE,EST_DD,CLS_ID,OANO) " +
                            " VALUES(to_date('" + qg.sqrq + "','yyyy-mm-dd hh24:mi:ss'),4,'" + qg.remark + "','" + idCode + "','" + department + "','2770',to_date('" + qg.qrrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "'," +
                            "'" + fid + "',to_date('" + qg.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'" + name + "',9,to_date('" + qg.yjrq + "','yyyy-mm-dd hh24:mi:ss'),'F','" + qg.oano + "') ";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from PUR_REQBILL_DETAIL where oano='" + qg.oano + "' and productid ='" + qg.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = qg.xh + 1;
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO PUR_REQBILL_DETAIL(INDEX_CODE,PRODUCTID,NEEDMANY,LIFE_CODE,RE_MARK,NEEDDAY,FNO,TEMPINQTY,FID,INQTY,OANO) " +
                                " VALUES('" + xh1 + "','" + qg.wlbh + "','" + qg.xqsl + "',4,'" + qg.bz + "',to_date('" + qg.yhrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "',0,'" + fid + "',0,'" + qg.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //在oa数据库中添加 采购单号和序号
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.* from FORMTABLE_MAIN_330 A left join FORMTABLE_MAIN_330_DT1 B on A.id = B.mainid where qgdh='" + qg.oano + "' and bh5='" + qg.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string oaid = dt.Rows[0]["ID"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set xh='" + xh1 + "' ,cgdh = '" + fno + "' where id='" + oaid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                        }
                        return "1";
                    }
                    else
                    {
                        string fno = dt.Rows[0]["FNO"].ToString();
                        string id = dt.Rows[0]["FID"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from PUR_REQBILL_DETAIL where oano='" + qg.oano + "' and productid ='" + qg.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = qg.xh + 1;
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO PUR_REQBILL_DETAIL(INDEX_CODE,PRODUCTID,NEEDMANY,LIFE_CODE,RE_MARK,NEEDDAY,FNO,TEMPINQTY,FID,INQTY,OANO) " +
                                " VALUES('" + xh1 + "','" + qg.wlbh + "','" + qg.xqsl + "',4,'" + qg.bz + "',to_date('" + qg.yhrq + "','yyyy-mm-dd hh24:mi:ss'),'" + fno + "',0,'" + id + "',0,'" + qg.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //在oa数据库中添加 采购单号和序号
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.* from FORMTABLE_MAIN_330 A left join FORMTABLE_MAIN_330_DT1 B on A.id = B.mainid where qgdh='" + qg.oano + "' and bh5='" + qg.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string oaid = dt.Rows[0]["ID"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set xh='" + xh1 + "' ,cgdh = '" + fno + "' where id='" + oaid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 办公用品入库单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGRK(string time)
        {
            try
            {
                ToolHelper.logger.Debug(time);
                BGRKInfo rk = new JavaScriptSerializer().Deserialize<BGRKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + rk.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from STORAGE_HEAD where id_code like '%CGRK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;

                        
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'00','0','" + rk.remark + "','1',null,'1'," +
                            " to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '" + rk.sl + "','0','1',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'4','" + fid + "','" + rk.zs + "',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','" + rk.kslb + "','" + rk.lzfs + "','" + rk.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from in_storage_detial where oano='" + rk.oano + "' and product_code ='" + rk.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ydbh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);
                            //添加子表
                            int xh1 = rk.xh + 1;
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO in_storage_detial (PRODUCT_CODE,INDEX_CODE,ID_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,IN_MANY,MPSID,MPSINDEX,BILLID," +
                                " BILLINDEX,FID,FSOURCE,FUSERID,TAX_RTO,TAX,AMTN,OANO) " +
                                " VALUES( '" + rk.wlbh + "', '" + xh1 + "','" + id_code + "','1','" + rk.rksl + "','" + rk.dj + "','临时','20','" + rk.remark + "','" + rk.dwbh + "','" + rk.rksl + "','" + ydbh + "','" + rk.yxh + "',''," +
                                " '','" + fid + "','1','1','" + rk.sl + "','" + rk.se + "','" + rk.wsbwb + "','" + rk.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //先查询主键 再修改

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string cgdh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from FORMTABLE_MAIN_330_DT1  where cgdh='" + cgdh + "' and bh='" + rk.wlbh + "'";
                            //sql = " select A.lcbh,B.* from formtable_main_349 a left join FORMTABLE_MAIN_349_DT1 b on a.id=b.mainid where A.lcbh='"+rk.oano+"' and B.wlbh='"+rk.wlbh+"'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string id = dt.Rows[0]["ID"].ToString();
                            string ycgsl= dt.Rows[0]["YCGSL"].ToString();
                            ToolHelper.CloseSql(conn);
                            if (ycgsl == null)
                            {
                                ycgsl = "0";
                            }
                            int aa = Convert.ToInt32(Convert.ToDouble(rk.rksl));
                            int number = aa + Convert.ToInt32(ycgsl);
                            string n = Convert.ToString(number);
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set ycgsl='" + n + "'  where id='" + id + "'";
                            //sql = "update FORMTABLE_MAIN_349_DT1 set rkdh='"+ id_code + "',xh='"+ xh1 + "',ycgsl='" + n + "'  where id='" + id + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //FORMTABLE_MAIN_349_DT1
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.id from formtable_main_349 a left join FORMTABLE_MAIN_349_DT1 b on a.id=b.mainid where A.lcbh='" + rk.oano + "' and B.wlbh='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ida = dt.Rows[0]["ID"].ToString();
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_349_DT1 set rkdh='" + id_code + "'  where id='" + ida + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //修改主表life_code=2
                            if (rk.zs == xh1)
                            {
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_HEAD set life_code='2' where fid='" + fid + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from in_storage_detial where oano='" + rk.oano + "' and product_code ='" + rk.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ydbh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);
                            //添加子表
                            int xh1 = rk.xh + 1;
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO in_storage_detial (PRODUCT_CODE,INDEX_CODE,ID_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,IN_MANY,MPSID,MPSINDEX,BILLID," +
                                " BILLINDEX,FID,FSOURCE,FUSERID,TAX_RTO,TAX,AMTN,OANO) " +
                                " VALUES( '" + rk.wlbh + "', '" + xh1 + "','" + id_code + "','1','" + rk.rksl + "','" + rk.dj + "','临时','20','" + rk.remark + "','" + rk.dwbh + "','" + rk.rksl + "','" + ydbh + "','" + rk.yxh + "',''," +
                                " '','" + fid + "','1','1','" + rk.sl + "','" + rk.se + "','" + rk.wsbwb + "','" + rk.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string cgdh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from FORMTABLE_MAIN_330_DT1  where cgdh='" + cgdh + "' and bh='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string id = dt.Rows[0]["ID"].ToString();
                            string ycgsl = dt.Rows[0]["YCGSL"].ToString();
                            ToolHelper.CloseSql(conn);
                            if (ycgsl == null)
                            {
                                ycgsl = "0";
                            }
                            int a = Convert.ToInt32(Convert.ToDouble(rk.rksl));
                            int b = Convert.ToInt32(ycgsl);
                            int number = a + Convert.ToInt32(ycgsl);
                            string n = Convert.ToString(number);
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set ycgsl='" + n + "'  where id='" + id + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.id from formtable_main_349 a left join FORMTABLE_MAIN_349_DT1 b on a.id=b.mainid where A.lcbh='" + rk.oano + "' and B.wlbh='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ida = dt.Rows[0]["ID"].ToString();
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_349_DT1 set rkdh='" + id_code + "'  where id='" + ida + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (rk.zs == xh1)
                            {
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_HEAD set life_code='2' where fid='" + fid + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)

            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 实业办公用品入库单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGRK1(string time)
        {
            try
            {
                ToolHelper.logger.Debug(time);
                BGRKInfo rk = new JavaScriptSerializer().Deserialize<BGRKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("21");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + rk.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from STORAGE_HEAD where id_code like '%CGRK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'" + rk.dwid + "','0','" + rk.remark + "','1',null,'1'," +
                            " to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '" + rk.sl + "','0','1',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'4','" + fid + "','" + rk.zs + "',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','" + rk.kslb + "','" + rk.lzfs + "','" + rk.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from in_storage_detial where oano='" + rk.oano + "' and product_code ='" + rk.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ydbh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);
                            //添加子表
                            int xh1 = rk.xh + 1;
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO in_storage_detial (PRODUCT_CODE,INDEX_CODE,ID_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,IN_MANY,MPSID,MPSINDEX,BILLID," +
                                " BILLINDEX,FID,FSOURCE,FUSERID,TAX_RTO,TAX,AMTN,OANO) " +
                                " VALUES( '" + rk.wlbh + "', '" + xh1 + "','" + id_code + "','1','" + rk.rksl + "','" + rk.dj + "','临时','20','" + rk.remark + "','" + rk.dwbh + "','" + rk.rksl + "','" + ydbh + "','" + rk.yxh + "',''," +
                                " '','" + fid + "','1','1','" + rk.sl + "','" + rk.se + "','" + rk.wsbwb + "','" + rk.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //先查询主键 再修改
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string cgdh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from FORMTABLE_MAIN_330_DT1  where cgdh='" + cgdh + "' and bh1='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string id = dt.Rows[0]["ID"].ToString();
                            string ycgsl = dt.Rows[0]["YCGSL"].ToString();
                            ToolHelper.CloseSql(conn);
                            if (ycgsl == null)
                            {
                                ycgsl = "0";
                            }
                            int number = Convert.ToInt32(Convert.ToDouble(rk.rksl)) + Convert.ToInt32(ycgsl);
                            string n = Convert.ToString(number);
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set ycgsl='" + n + "' where id='" + id + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.id from formtable_main_349 a left join FORMTABLE_MAIN_349_DT1 b on a.id=b.mainid where A.lcbh='" + rk.oano + "' and B.wlbh1='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ida = dt.Rows[0]["ID"].ToString();
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_349_DT1 set rkdh='" + id_code + "'  where id='" + ida + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (rk.zs == xh1)
                            {
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_HEAD set life_code='2' where fid='" + fid + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from in_storage_detial where oano='" + rk.oano + "' and product_code ='" + rk.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ydbh = dt.Rows[0]["CGDH"].ToString();
                            //添加子表
                            int xh1 = rk.xh + 1;
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO in_storage_detial (PRODUCT_CODE,INDEX_CODE,ID_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,IN_MANY,MPSID,MPSINDEX,BILLID," +
                                " BILLINDEX,FID,FSOURCE,FUSERID,TAX_RTO,TAX,AMTN,OANO) " +
                                " VALUES( '" + rk.wlbh + "', '" + xh1 + "','" + id_code + "','1','" + rk.rksl + "','" + rk.dj + "','临时','20','" + rk.remark + "','" + rk.dwbh + "','" + rk.rksl + "','" + ydbh + "','" + rk.yxh + "',''," +
                                " '','" + fid + "','1','1','" + rk.sl + "','" + rk.se + "','" + rk.wsbwb + "','" + rk.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string cgdh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from FORMTABLE_MAIN_330_DT1  where cgdh='" + cgdh + "' and bh1='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string id = dt.Rows[0]["ID"].ToString();
                            string ycgsl = dt.Rows[0]["YCGSL"].ToString();
                            ToolHelper.CloseSql(conn);
                            if (ycgsl == null)
                            {
                                ycgsl = "0";
                            }
                            int number = Convert.ToInt32(Convert.ToDouble(rk.rksl)) + Convert.ToInt32(ycgsl);
                            string n = Convert.ToString(number);
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set ycgsl='" + n + "'  where id='" + id + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.id from formtable_main_349 a left join FORMTABLE_MAIN_349_DT1 b on a.id=b.mainid where A.lcbh='" + rk.oano + "' and B.wlbh1='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ida = dt.Rows[0]["ID"].ToString();
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_349_DT1 set rkdh='" + id_code + "'  where id='" + ida + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (rk.zs == xh1)
                            {
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_HEAD set life_code='2' where fid='" + fid + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)

            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 五厂办公用品入库单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGRK5(string time)
        {
            try
            {
                ToolHelper.logger.Debug(time);
                BGRKInfo rk = new JavaScriptSerializer().Deserialize<BGRKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("22");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + rk.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from STORAGE_HEAD where id_code like '%CGRK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'" + rk.dwid + "','0','" + rk.remark + "','1',null,'1'," +
                            " to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '" + rk.sl + "','0','1',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss'),'4','" + fid + "','" + rk.zs + "',to_date('" + rk.zdrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','" + rk.kslb + "','" + rk.lzfs + "','" + rk.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from in_storage_detial where oano='" + rk.oano + "' and product_code ='" + rk.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ydbh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);
                            //添加子表
                            int xh1 = rk.xh + 1;
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO in_storage_detial (PRODUCT_CODE,INDEX_CODE,ID_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,IN_MANY,MPSID,MPSINDEX,BILLID," +
                                " BILLINDEX,FID,FSOURCE,FUSERID,TAX_RTO,TAX,AMTN,OANO) " +
                                " VALUES( '" + rk.wlbh + "', '" + xh1 + "','" + id_code + "','1','" + rk.rksl + "','" + rk.dj + "','临时','20','" + rk.remark + "','" + rk.dwbh + "','" + rk.rksl + "','" + ydbh + "','" + rk.yxh + "',''," +
                                " '','" + fid + "','1','1','" + rk.sl + "','" + rk.se + "','" + rk.wsbwb + "','" + rk.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //先查询主键 再修改
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string cgdh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from FORMTABLE_MAIN_330_DT1  where cgdh='" + cgdh + "' and bh5='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string id = dt.Rows[0]["ID"].ToString();
                            string ycgsl = dt.Rows[0]["YCGSL"].ToString();
                            ToolHelper.CloseSql(conn);
                            if (ycgsl==null)
                            {
                                ycgsl = "0";
                            }
                            int number = Convert.ToInt32(Convert.ToDouble(rk.rksl)) + Convert.ToInt32(ycgsl);
                            string n = Convert.ToString(number);
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set ycgsl='" + n + "'  where id='" + id + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.id from formtable_main_349 a left join FORMTABLE_MAIN_349_DT1 b on a.id=b.mainid where A.lcbh='" + rk.oano + "' and B.wlbh5='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ida = dt.Rows[0]["ID"].ToString();
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_349_DT1 set rkdh='" + id_code + "'  where id='" + ida + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (rk.zs == xh1)
                            {
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_HEAD set life_code='2' where fid='" + fid + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from in_storage_detial where oano='" + rk.oano + "' and product_code ='" + rk.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ydbh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);
                            //添加子表
                            int xh1 = rk.xh + 1;
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO in_storage_detial (PRODUCT_CODE,INDEX_CODE,ID_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,IN_MANY,MPSID,MPSINDEX,BILLID," +
                                " BILLINDEX,FID,FSOURCE,FUSERID,TAX_RTO,TAX,AMTN,OANO) " +
                                " VALUES( '" + rk.wlbh + "', '" + xh1 + "','" + id_code + "','1','" + rk.rksl + "','" + rk.dj + "','临时','20','" + rk.remark + "','" + rk.dwbh + "','" + rk.rksl + "','" + ydbh + "','" + rk.yxh + "',''," +
                                " '','" + fid + "','1','1','" + rk.sl + "','" + rk.se + "','" + rk.wsbwb + "','" + rk.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from V_BGYPRK where id='" + rk.aa + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string cgdh = dt.Rows[0]["CGDH"].ToString();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select * from FORMTABLE_MAIN_330_DT1  where cgdh='" + cgdh + "' and bh5='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string id = dt.Rows[0]["ID"].ToString();
                            string ycgsl = dt.Rows[0]["YCGSL"].ToString();
                            ToolHelper.CloseSql(conn);
                            if (ycgsl == null)
                            {
                                ycgsl = "0";
                            }
                            int number = Convert.ToInt32(Convert.ToDouble(rk.rksl)) + Convert.ToInt32(ycgsl);
                            string n = Convert.ToString(number);
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_330_DT1 set ycgsl='" + n + "'  where id='" + id + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = " select B.id from formtable_main_349 a left join FORMTABLE_MAIN_349_DT1 b on a.id=b.mainid where A.lcbh='" + rk.oano + "' and B.wlbh5='" + rk.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            string ida = dt.Rows[0]["ID"].ToString();
                            conn = ToolHelper.OpenRavoerp("oa");
                            sql = "update FORMTABLE_MAIN_349_DT1 set rkdh='" + id_code + "'  where id='" + ida + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (rk.zs == xh1)
                            {
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_HEAD set life_code='2' where fid='" + fid + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                

                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)

            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 办公用品领用(出库)单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCK(string time)
        {
            try
            {
                ToolHelper.logger.Debug("办公用品领用(出库)单" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("23");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //修改主表life_code=2 测试时先注释
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("23");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 实业办公用品领用(出库)单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCK1(string time)
        {
            try
            {
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("21");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("21");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //修改主表life_code=2 测试时先注释
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("21");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 五厂办公用品领用(出库)单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCK5(string time)
        {
            try
            {
                ToolHelper.logger.Debug("办公用品领用(出库)单" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("22");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("22");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //修改主表life_code=2 测试时先注释
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("22");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 办公用品领用(出库)单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod] 
        public string SaveBGCKa(string time)
        {
            try
            {
                ToolHelper.logger.Debug("办公用品领用(出库)单" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();
                        ToolHelper.CloseSql(conn);
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;
                        ToolHelper.CloseSql(conn);
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        conn = ToolHelper.OpenRavoerp("oa");
                        sql = " select B.* from FORMTABLE_MAIN_42 a left join FORMTABLE_MAIN_42_DT1 b on a.id=b.mainid where a.lcbh='" + ck.oano + "' order by b.id ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        DataTable dta = new DataTable();
                        da.Fill(dta);
                        ToolHelper.logger.Debug("办公用品领用(出库)单SQL" + sql);
                        //string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string product_code = dta.Rows[0]["WLID"].ToString();
                        ToolHelper.logger.Debug("办公用品领用(出库)单WLID" + product_code);
                        ToolHelper.CloseSql(conn);
                        for (int i = 0; i < ck.zs - 1; i++)
                        {
                            //判断子表是否存在
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + dta.Rows[i]["WLID"].ToString() + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            num = dt.Rows.Count;
                            ToolHelper.CloseSql(conn);

                            if (num == 0)
                            {
                                ck.sfsl = "0";
                                //添加子表
                                int xh1 = ck.xh + 1;
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                    " VALUES( '" + id_code + "','" + dta.Rows[i]["WLID"].ToString() + "'," + i + 1 + ",1,0,0,'临时','20','" + dta.Rows[i]["BZ"].ToString() + "','" + dta.Rows[i]["DWID"].ToString() + "','" + dta.Rows[i]["XQSL"].ToString() + "'," + fid + ",'" + ck.oano + "',0,'" + dta.Rows[i]["CID"].ToString() + "') ";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);

                                conn = ToolHelper.OpenRavoerp("23");
                                sql = " select * from STORAGE_DETIAL where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                string run = dt.Rows[0]["RUNMANY"].ToString();
                                int run1 = Convert.ToInt32(run);
                                string run2 = dta.Rows[i]["XQSL"].ToString();
                                int run3 = Convert.ToInt32(run2);
                                ToolHelper.logger.Debug("办公用品领用(出库)单runmany" + run1+";"+ run3);
                                int runmany = run1 + run3;
                                ToolHelper.CloseSql(conn);

                                //runmany修改
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_DETIAL set RUNMANY='" + dta.Rows[i]["XQSL"].ToString() + "' where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                            }
                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        conn = ToolHelper.OpenRavoerp("oa");
                        sql = " select B.* from FORMTABLE_MAIN_42 a left join FORMTABLE_MAIN_42_DT1 b on a.id=b.mainid where a.lcbh='" + ck.oano + "' order by b.id ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        DataTable dta = new DataTable();
                        da.Fill(dta);
                        //string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880

                        ToolHelper.CloseSql(conn);
                        for (int i = 0; i < ck.zs - 1; i++)
                        {
                            //判断子表是否存在
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + dta.Rows[i]["WLID"].ToString() + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            num = dt.Rows.Count;
                            ToolHelper.CloseSql(conn);

                            if (num == 0)
                            {
                                ck.sfsl = "0";
                                //添加子表
                                int xh1 = ck.xh + 1;
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                    " VALUES( '" + id_code + "','" + dta.Rows[i]["WLID"].ToString() + "'," + i + 1 + ",1,0,0,'临时','20','" + dta.Rows[i]["BZ"].ToString() + "','" + dta.Rows[i]["DWID"].ToString() + "','" + dta.Rows[i]["XQSL"].ToString() + "'," + fid + ",'" + ck.oano + "',0,'" + dta.Rows[i]["CID"].ToString() + "') ";
                                cmd = new OracleCommand(sql, conn);
                                int result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);

                                
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_DETIAL set RUNMANY='" + dta.Rows[i]["XQSL"].ToString() + "' where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 实业办公用品领用(出库)单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCK1a(string time)
        {
            try
            {
                ToolHelper.logger.Debug("办公用品领用(出库)单" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("21");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();
                        ToolHelper.CloseSql(conn);
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;
                        ToolHelper.CloseSql(conn);
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        conn = ToolHelper.OpenRavoerp("oa");
                        sql = " select B.* from FORMTABLE_MAIN_42 a left join FORMTABLE_MAIN_42_DT1 b on a.id=b.mainid where a.lcbh='" + ck.oano + "' order by b.id ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        DataTable dta = new DataTable();
                        da.Fill(dta);
                        ToolHelper.logger.Debug("办公用品领用(出库)单SQL" + sql);
                        //string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string product_code = dta.Rows[0]["WLID"].ToString();
                        ToolHelper.logger.Debug("办公用品领用(出库)单WLID" + product_code);
                        ToolHelper.CloseSql(conn);
                        for (int i = 0; i < ck.zs - 1; i++)
                        {
                            //判断子表是否存在
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + dta.Rows[i]["WLID"].ToString() + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            num = dt.Rows.Count;
                            ToolHelper.CloseSql(conn);

                            if (num == 0)
                            {
                                ck.sfsl = "0";
                                //添加子表
                                int xh1 = ck.xh + 1;
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                    " VALUES( '" + id_code + "','" + dta.Rows[i]["WLID"].ToString() + "'," + i + 1 + ",1,0,0,'临时','20','" + dta.Rows[i]["BZ"].ToString() + "','" + dta.Rows[i]["DWID"].ToString() + "','" + dta.Rows[i]["XQSL"].ToString() + "'," + fid + ",'" + ck.oano + "',0,'" + dta.Rows[i]["CID"].ToString() + "') ";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);

                                conn = ToolHelper.OpenRavoerp("21");
                                sql = " select * from STORAGE_DETIAL where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                string run = dt.Rows[0]["RUNMANY"].ToString();
                                int run1 = Convert.ToInt32(run);
                                string run2 = dta.Rows[i]["XQSL"].ToString();
                                int run3 = Convert.ToInt32(run2);
                                ToolHelper.logger.Debug("办公用品领用(出库)单runmany" + run1 + ";" + run3);
                                int runmany = run1 + run3;
                                ToolHelper.CloseSql(conn);

                                //runmany修改
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_DETIAL set RUNMANY='" + dta.Rows[i]["XQSL"].ToString() + "' where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                            }
                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        conn = ToolHelper.OpenRavoerp("oa");
                        sql = " select B.* from FORMTABLE_MAIN_42 a left join FORMTABLE_MAIN_42_DT1 b on a.id=b.mainid where a.lcbh='" + ck.oano + "' order by b.id ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        DataTable dta = new DataTable();
                        da.Fill(dta);
                        //string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880

                        ToolHelper.CloseSql(conn);
                        for (int i = 0; i < ck.zs - 1; i++)
                        {
                            //判断子表是否存在
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + dta.Rows[i]["WLID"].ToString() + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            num = dt.Rows.Count;
                            ToolHelper.CloseSql(conn);

                            if (num == 0)
                            {
                                ck.sfsl = "0";
                                //添加子表
                                int xh1 = ck.xh + 1;
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                    " VALUES( '" + id_code + "','" + dta.Rows[i]["WLID"].ToString() + "'," + i + 1 + ",1,0,0,'临时','20','" + dta.Rows[i]["BZ"].ToString() + "','" + dta.Rows[i]["DWID"].ToString() + "','" + dta.Rows[i]["XQSL"].ToString() + "'," + fid + ",'" + ck.oano + "',0,'" + dta.Rows[i]["CID"].ToString() + "') ";
                                cmd = new OracleCommand(sql, conn);
                                int result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_DETIAL set RUNMANY='" + dta.Rows[i]["XQSL"].ToString() + "' where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 五厂办公用品领用(出库)单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCK5a(string time)
        {
            try
            {
                ToolHelper.logger.Debug("办公用品领用(出库)单" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("22");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();
                        ToolHelper.CloseSql(conn);
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;
                        ToolHelper.CloseSql(conn);
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        conn = ToolHelper.OpenRavoerp("oa");
                        sql = " select B.* from FORMTABLE_MAIN_42 a left join FORMTABLE_MAIN_42_DT1 b on a.id=b.mainid where a.lcbh='" + ck.oano + "' order by b.id ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        DataTable dta = new DataTable();
                        da.Fill(dta);
                        ToolHelper.logger.Debug("办公用品领用(出库)单SQL" + sql);
                        //string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string product_code = dta.Rows[0]["WLID"].ToString();
                        ToolHelper.logger.Debug("办公用品领用(出库)单WLID" + product_code);
                        ToolHelper.CloseSql(conn);
                        for (int i = 0; i < ck.zs - 1; i++)
                        {
                            //判断子表是否存在
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + dta.Rows[i]["WLID"].ToString() + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            num = dt.Rows.Count;
                            ToolHelper.CloseSql(conn);

                            if (num == 0)
                            {
                                ck.sfsl = "0";
                                //添加子表
                                int xh1 = ck.xh + 1;
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                    " VALUES( '" + id_code + "','" + dta.Rows[i]["WLID"].ToString() + "'," + i + 1 + ",1,0,0,'临时','20','" + dta.Rows[i]["BZ"].ToString() + "','" + dta.Rows[i]["DWID"].ToString() + "','" + dta.Rows[i]["XQSL"].ToString() + "'," + fid + ",'" + ck.oano + "',0,'" + dta.Rows[i]["CID"].ToString() + "') ";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);

                                conn = ToolHelper.OpenRavoerp("22");
                                sql = " select * from STORAGE_DETIAL where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                da = new OracleDataAdapter(cmd);
                                dt = new DataTable();
                                da.Fill(dt);
                                string run = dt.Rows[0]["RUNMANY"].ToString();
                                int run1 = Convert.ToInt32(run);
                                string run2 = dta.Rows[i]["XQSL"].ToString();
                                int run3 = Convert.ToInt32(run2);
                                ToolHelper.logger.Debug("办公用品领用(出库)单runmany" + run1 + ";" + run3);
                                int runmany = run1 + run3;
                                ToolHelper.CloseSql(conn);

                                //runmany修改
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_DETIAL set RUNMANY='" + dta.Rows[i]["XQSL"].ToString() + "' where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                            }
                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        conn = ToolHelper.OpenRavoerp("oa");
                        sql = " select B.* from FORMTABLE_MAIN_42 a left join FORMTABLE_MAIN_42_DT1 b on a.id=b.mainid where a.lcbh='" + ck.oano + "' order by b.id ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        DataTable dta = new DataTable();
                        da.Fill(dta);
                        //string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880

                        ToolHelper.CloseSql(conn);
                        for (int i = 0; i < ck.zs - 1; i++)
                        {
                            //判断子表是否存在
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + dta.Rows[i]["WLID"].ToString() + "'";
                            cmd = new OracleCommand(sql, conn);
                            da = new OracleDataAdapter(cmd);
                            dt = new DataTable();
                            da.Fill(dt);
                            num = dt.Rows.Count;
                            ToolHelper.CloseSql(conn);

                            if (num == 0)
                            {
                                ck.sfsl = "0";
                                //添加子表
                                int xh1 = ck.xh + 1;
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                    " VALUES( '" + id_code + "','" + dta.Rows[i]["WLID"].ToString() + "'," + i + 1 + ",1,0,0,'临时','20','" + dta.Rows[i]["BZ"].ToString() + "','" + dta.Rows[i]["DWID"].ToString() + "','" + dta.Rows[i]["XQSL"].ToString() + "'," + fid + ",'" + ck.oano + "',0,'" + dta.Rows[i]["CID"].ToString() + "') ";
                                cmd = new OracleCommand(sql, conn);
                                int result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_DETIAL set RUNMANY='" + dta.Rows[i]["XQSL"].ToString() + "' where cid='" + dta.Rows[i]["CID"].ToString() + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);


                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 办公用品出库单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCKb(string time)
        {
            try
            {
                ToolHelper.logger.Debug("办公用品领用(出库)单" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("23");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("23");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //修改主表life_code=2 测试时先注释
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("23");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        int xh1 = ck.xh + 1;
                        if (num == 0)
                        {
                            //添加子表
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("23");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        else
                        {
                            conn = ToolHelper.OpenRavoerp("23");
                            sql = "update out_storage_detial set many='"+ck.sfsl + "' where oano='" + ck.oano + "' and product_code='"+ ck.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("23");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 实业办公用品出库单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCK1b(string time)
        {
            try
            {
                //ToolHelper.logger.Debug("办公用品领用(出库)单" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("21");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("21");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //修改主表life_code=2 测试时先注释
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("21");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        int xh1 = ck.xh + 1;
                        if (num == 0)
                        {
                            //添加子表
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("21");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        else
                        {
                            conn = ToolHelper.OpenRavoerp("21");
                            sql = "update out_storage_detial set many='" + ck.sfsl + "' where oano='" + ck.oano + "' and product_code='" + ck.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("21");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 五厂办公用品出库单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGCK5b(string time)
        {
            try
            {
                ToolHelper.logger.Debug("办公用品领用(出库)单5" + time);
                BGCKInfo ck = new JavaScriptSerializer().Deserialize<BGCKInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("22");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from STORAGE_HEAD where oano='" + ck.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        //获取id_code和fid
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();

                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from STORAGE_HEAD where id_code like '%BGCK%' order by id_code desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();//CGRK20-00880
                        string a = id_code.Substring(7);//00880
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(5, '0');
                        string d = id_code.Substring(0, id_code.Length - 5);
                        id_code = d + c;


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " INSERT INTO STORAGE_HEAD (ID_CODE,WAREHOUSE,USER_CODE,WARE_MAN,INPUT_DAY,INPUT_DEPARTMENT,CHECKED,REMARK,TYPE_CODE,OLD_CODE,LIFE_CODE," +
                            " OK_DAY,PY,PRICEOVER,REALDAY,CERTIFY,CERTIFYDAY,ZZFP,PRICEUNIT,DECIDEMAN,PLANDAY,FBILLTYPE,FID,FROWCOUNT,SENDDAY,FDEPT,SQUE_CODE,TAX_ID,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "','20','1','',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'00 ','0','" + ck.remark + "','1',null,'1'," +
                            " to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'行政部','0',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '0','0','1',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss'),'302','" + fid + "','" + ck.zs + "',to_date('" + ck.sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '00','NONE','','','" + ck.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        ToolHelper.CloseSql(conn);
                        //判断子表是否存在
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = ck.xh + 1;
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("22");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            //修改主表life_code=2 测试时先注释
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }

                        }
                        return "1";
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["ID_CODE"].ToString();
                        //判断子表是否存在 
                        conn = ToolHelper.OpenRavoerp("22");
                        sql = " select * from out_storage_detial where oano='" + ck.oano + "' and product_code ='" + ck.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        ToolHelper.CloseSql(conn);
                        int xh1 = ck.xh + 1;
                        if (num == 0)
                        {
                            //添加子表
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = " INSERT INTO out_storage_detial (ID_CODE,PRODUCT_CODE,INDEX_CODE,PCS,MANY,PRICE,WARE_UNIT,WAREHOUSE,RE_MARK,PUNIT,OUT_MANY,FID,OANO,CKOUT_MANY,STORAGE_DETIALID) " +
                                " VALUES( '" + id_code + "','" + ck.wlbh + "'," + xh1 + ",1,'" + ck.sfsl + "',0,'临时','20','" + ck.bz + "','" + ck.dwid + "','" + ck.xqsl + "'," + fid + ",'" + ck.oano + "','" + ck.sfsl + "','" + ck.cid + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);

                            conn = ToolHelper.OpenRavoerp("22");
                            sql = "update STORAGE_DETIAL set RUNMANY='" + ck.sfsl + "' where cid='" + ck.cid + "'";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            //修改主表life_code=2
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        else
                        {
                            conn = ToolHelper.OpenRavoerp("22");
                            sql = "update out_storage_detial set many='"+ck.sfsl + "' where oano='" + ck.oano + "' and product_code='"+ ck.wlbh + "'";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            if (ck.zs == xh1)
                            {
                                Thread.Sleep(1000);
                                conn = ToolHelper.OpenRavoerp("22");
                                sql = "update STORAGE_HEAD set life_code='2' where oano='" + ck.oano + "'";
                                cmd = new OracleCommand(sql, conn);
                                result = cmd.ExecuteNonQuery();
                                ToolHelper.CloseSql(conn);
                            }
                        }
                        return "1";
                    }
                }
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                return "";
            }
        }
        /// <summary>
        /// 办公用品应付单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGYF(string time)
        {
            string type = "23";
            OracleConnection conn = ToolHelper.OpenRavoerp(type);
            OracleCommand myCommand = conn.CreateCommand();
            OracleTransaction transaction;
            transaction = conn.BeginTransaction(IsolationLevel.ReadCommitted);//开启本地事务
            myCommand.Transaction = transaction;//为挂起的本地事务分配事务对象
            try
            {
                BGYFInfo yf = new JavaScriptSerializer().Deserialize<BGYFInfo>(time);
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from RCPYHEAD where oano='" + yf.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    if (num == 0)
                    {
                        //获取id_code和fid
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();
                        sql = " select * from RCPYHEAD where rcpyid like '%YF%' order by rcpyid desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["RCPYID"].ToString();//YF20-000091
                        string a = id_code.Substring(5);//
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(6, '0');
                        string d = id_code.Substring(0, id_code.Length - 6);
                        id_code = d + c;

                        sql = " select * from sys_user where fid='"+yf.gh+"' ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string user = dt.Rows[0]["ID_CODE"].ToString();


                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        sql = " INSERT INTO RCPYHEAD (RCPYID,BEGINDAY,PLANPAYDAY,LIFECODE,COMPANY,BZ,HL,USERID,TAX,TAXRATE,MANY,RE_MARK,JD,CHECKER,CHECKDAY,INVOICEID," +
                            " COST,SENDDATE,FDEPT,FBILLMANY,FID,FNOTE,FPLANPAYDAY,BILLTYPE,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "',to_date('" + yf.sqrq + "','yyyy-mm-dd hh24:mi:ss'),to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'4','"+yf.dwid+"'," +
                            " 'RMB','"+yf.hl+"','"+user+"','"+yf.kslb+"','"+yf.sl+"','"+yf.je+"','"+yf.zy+ "','-1','1',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'"+yf.fph+"'," +
                            " '"+yf.qtfy+ "',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'00','0','"+fid+"','"+yf.hxyq+ "',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '98','"+yf.lzfs+"','"+yf.oano+"')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        //判断子表是否存在
                        sql = " select * from RCPYDETAIL where oano='" + yf.oano + "' and FPRODUCT ='" + yf.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = yf.xh + 1;
                            sql = " INSERT INTO RCPYDETAIL (FID,FSOURCEID,FSOURCEINDEX,FPRODUCT,FPRICE,FQTY,FREMARK,FPUNIT,RCPYID,PCS,FSOURCE,FINDEX,FFX,TAX_RTO,TAX,AMTN,AMT,OANO) " +
                                " VALUES('" + fid + "','"+yf.rkdh+"','"+yf.ydxh+"','"+yf.wlbh+"','"+yf.dj+"','"+yf.sl1+"','"+yf.bz+"','"+yf.dwidd+"','"+ id_code + "','1','4','"+xh1+"','1'," +
                                "'"+yf.sl+"','"+yf.se+"','"+yf.wsbwb+"','"+yf.je1+"','"+yf.oano+"') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();

                        }
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["RCPYID"].ToString();
                        sql = " select * from RCPYDETAIL where oano='" + yf.oano + "' and FPRODUCT ='" + yf.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = yf.xh + 1;
                            sql = " INSERT INTO RCPYDETAIL (FID,FSOURCEID,FSOURCEINDEX,FPRODUCT,FPRICE,FQTY,FREMARK,FPUNIT,RCPYID,PCS,FSOURCE,FINDEX,FFX,TAX_RTO,TAX,AMTN,AMT,OANO) " +
                                " VALUES('" + fid + "','" + yf.rkdh + "','" + yf.ydxh + "','" + yf.wlbh + "','" + yf.dj + "','" + yf.sl1 + "','" + yf.bz + "','" + yf.dwidd + "','" + id_code + "','1','4','" + xh1 + "','1'," +
                                "'" + yf.sl + "','" + yf.se + "','" + yf.wsbwb + "','" + yf.je1 + "','" + yf.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                        }
                    }
                }
                transaction.Commit();
                ToolHelper.CloseSql(conn);
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                transaction.Rollback();
                ToolHelper.CloseSql(conn);
                return "";
            }
        }
        /// <summary>
        /// 实业办公用品应付单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGYF1(string time)
        {
            string type = "21";
            OracleConnection conn = ToolHelper.OpenRavoerp(type);
            OracleCommand myCommand = conn.CreateCommand();
            OracleTransaction transaction;
            transaction = conn.BeginTransaction(IsolationLevel.ReadCommitted);//开启本地事务
            myCommand.Transaction = transaction;//为挂起的本地事务分配事务对象
            try
            {
                BGYFInfo yf = new JavaScriptSerializer().Deserialize<BGYFInfo>(time);
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from RCPYHEAD where oano='" + yf.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    if (num == 0)
                    {
                        //获取id_code和fid
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();
                        sql = " select * from RCPYHEAD where rcpyid like '%YF%' order by rcpyid desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["RCPYID"].ToString();//YF20-000091
                        string a = id_code.Substring(5);//
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(6, '0');
                        string d = id_code.Substring(0, id_code.Length - 6);
                        id_code = d + c;
                        sql = " select * from sys_user where fid='" + yf.gh + "' ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string user = dt.Rows[0]["ID_CODE"].ToString();

                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        sql = " INSERT INTO RCPYHEAD (RCPYID,BEGINDAY,PLANPAYDAY,LIFECODE,COMPANY,BZ,HL,USERID,TAX,TAXRATE,MANY,RE_MARK,JD,CHECKER,CHECKDAY,INVOICEID," +
                            " COST,SENDDATE,FDEPT,FBILLMANY,FID,FNOTE,FPLANPAYDAY,BILLTYPE,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "',to_date('" + yf.sqrq + "','yyyy-mm-dd hh24:mi:ss'),to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'4','" + yf.dwid + "'," +
                            " 'RMB','" + yf.hl + "','"+user+"','" + yf.kslb + "','" + yf.sl + "','" + yf.je + "','" + yf.zy + "','-1','1',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'" + yf.fph + "'," +
                            " '" + yf.qtfy + "',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'00','0','" + fid + "','" + yf.hxyq + "',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '98','" + yf.lzfs + "','" + yf.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        //判断子表是否存在
                        sql = " select * from RCPYDETAIL where oano='" + yf.oano + "' and FPRODUCT ='" + yf.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = yf.xh + 1;
                            sql = " INSERT INTO RCPYDETAIL (FID,FSOURCEID,FSOURCEINDEX,FPRODUCT,FPRICE,FQTY,FREMARK,FPUNIT,RCPYID,PCS,FSOURCE,FINDEX,FFX,TAX_RTO,TAX,AMTN,AMT,OANO) " +
                                " VALUES('" + fid + "','" + yf.rkdh + "','" + yf.ydxh + "','" + yf.wlbh + "','" + yf.dj + "','" + yf.sl1 + "','" + yf.bz + "','" + yf.dwidd + "','" + id_code + "','1','4','" + xh1 + "','1'," +
                                "'" + yf.sl + "','" + yf.se + "','" + yf.wsbwb + "','" + yf.je1 + "','" + yf.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();


                        }
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["RCPYID"].ToString();
                        sql = " select * from RCPYDETAIL where oano='" + yf.oano + "' and FPRODUCT ='" + yf.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = yf.xh + 1;
                            sql = " INSERT INTO RCPYDETAIL (FID,FSOURCEID,FSOURCEINDEX,FPRODUCT,FPRICE,FQTY,FREMARK,FPUNIT,RCPYID,PCS,FSOURCE,FINDEX,FFX,TAX_RTO,TAX,AMTN,AMT,OANO) " +
                                " VALUES('" + fid + "','" + yf.rkdh + "','" + yf.ydxh + "','" + yf.wlbh + "','" + yf.dj + "','" + yf.sl1 + "','" + yf.bz + "','" + yf.dwidd + "','" + id_code + "','1','4','" + xh1 + "','1'," +
                                "'" + yf.sl + "','" + yf.se + "','" + yf.wsbwb + "','" + yf.je1 + "','" + yf.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();

                        }
                    }
                }
                transaction.Commit();
                ToolHelper.CloseSql(conn);
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                transaction.Rollback();
                ToolHelper.CloseSql(conn);
                return "";
            }
        }
        /// <summary>
        /// 五厂办公用品应付单
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveBGYF5(string time)
        {
            string type = "22";
            OracleConnection conn = ToolHelper.OpenRavoerp(type);
            OracleCommand myCommand = conn.CreateCommand();
            OracleTransaction transaction;
            transaction = conn.BeginTransaction(IsolationLevel.ReadCommitted);//开启本地事务
            myCommand.Transaction = transaction;//为挂起的本地事务分配事务对象
            try
            {
                BGYFInfo yf = new JavaScriptSerializer().Deserialize<BGYFInfo>(time);
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from RCPYHEAD where oano='" + yf.oano + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    if (num == 0)
                    {
                        //获取id_code和fid
                        sql = " select s_public.nextval fid into :ll_id  from dual ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string fid = dt.Rows[0]["FID"].ToString();
                        sql = " select * from RCPYHEAD where rcpyid like '%YF%' order by rcpyid desc ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string id_code = dt.Rows[0]["RCPYID"].ToString();//YF20-000091
                        string a = id_code.Substring(5);//
                        int b = Convert.ToInt32(a) + 1;
                        string c = Convert.ToString(b).PadLeft(6, '0');
                        string d = id_code.Substring(0, id_code.Length - 6);
                        id_code = d + c;

                        sql = " select * from sys_user where fid='" + yf.gh + "' ";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string user = dt.Rows[0]["ID_CODE"].ToString();
                        //添加主表 to_date('" + dayy + "','yyyy-mm-dd hh24:mi:ss')
                        sql = " INSERT INTO RCPYHEAD (RCPYID,BEGINDAY,PLANPAYDAY,LIFECODE,COMPANY,BZ,HL,USERID,TAX,TAXRATE,MANY,RE_MARK,JD,CHECKER,CHECKDAY,INVOICEID," +
                            " COST,SENDDATE,FDEPT,FBILLMANY,FID,FNOTE,FPLANPAYDAY,BILLTYPE,ZHANG_ID,OANO) " +
                            " VALUES ( '" + id_code + "',to_date('" + yf.sqrq + "','yyyy-mm-dd hh24:mi:ss'),to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'4','" + yf.dwid + "'," +
                            " 'RMB','" + yf.hl + "','"+user+"','" + yf.kslb + "','" + yf.sl + "','" + yf.je + "','" + yf.zy + "','-1','1',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'" + yf.fph + "'," +
                            " '" + yf.qtfy + "',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss'),'00','0','" + fid + "','" + yf.hxyq + "',to_date('" + yf.fkrq + "','yyyy-mm-dd hh24:mi:ss')," +
                            " '98','" + yf.lzfs + "','" + yf.oano + "')";
                        cmd = new OracleCommand(sql, conn);
                        int result = cmd.ExecuteNonQuery();
                        //判断子表是否存在
                        sql = " select * from RCPYDETAIL where oano='" + yf.oano + "' and FPRODUCT ='" + yf.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = yf.xh + 1;
                            sql = " INSERT INTO RCPYDETAIL (FID,FSOURCEID,FSOURCEINDEX,FPRODUCT,FPRICE,FQTY,FREMARK,FPUNIT,RCPYID,PCS,FSOURCE,FINDEX,FFX,TAX_RTO,TAX,AMTN,AMT,OANO) " +
                                " VALUES('" + fid + "','" + yf.rkdh + "','" + yf.ydxh + "','" + yf.wlbh + "','" + yf.dj + "','" + yf.sl1 + "','" + yf.bz + "','" + yf.dwidd + "','" + id_code + "','1','4','" + xh1 + "','1'," +
                                "'" + yf.sl + "','" + yf.se + "','" + yf.wsbwb + "','" + yf.je1 + "','" + yf.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            result = cmd.ExecuteNonQuery();

                        }
                    }
                    else
                    {
                        string fid = dt.Rows[0]["FID"].ToString();
                        string id_code = dt.Rows[0]["RCPYID"].ToString();
                        sql = " select * from RCPYDETAIL where oano='" + yf.oano + "' and FPRODUCT ='" + yf.wlbh + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        num = dt.Rows.Count;
                        if (num == 0)
                        {
                            //添加子表
                            int xh1 = yf.xh + 1;
                            sql = " INSERT INTO RCPYDETAIL (FID,FSOURCEID,FSOURCEINDEX,FPRODUCT,FPRICE,FQTY,FREMARK,FPUNIT,RCPYID,PCS,FSOURCE,FINDEX,FFX,TAX_RTO,TAX,AMTN,AMT,OANO) " +
                                " VALUES('" + fid + "','" + yf.rkdh + "','" + yf.ydxh + "','" + yf.wlbh + "','" + yf.dj + "','" + yf.sl1 + "','" + yf.bz + "','" + yf.dwidd + "','" + id_code + "','1','4','" + xh1 + "','1'," +
                                "'" + yf.sl + "','" + yf.se + "','" + yf.wsbwb + "','" + yf.je1 + "','" + yf.oano + "') ";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();

                        }
                    }
                }
                transaction.Commit();
                ToolHelper.CloseSql(conn);
                return "";
            }
            catch (Exception e)
            {
                ToolHelper.logger.Debug("错误" + e.ToString());
                transaction.Rollback();
                ToolHelper.CloseSql(conn);
                return "";
            }
        }
        #endregion

        /// <summary>
        /// 模具维修
        /// </summary>
        /// <param name="time"></param>
        /// <returns></returns>
        [WebMethod]
        public string SaveMJWX(string time)
        {
            try
            {
                MJWXInfo mj = new JavaScriptSerializer().Deserialize<MJWXInfo>(time);
                OracleConnection conn = ToolHelper.OpenRavoerp("middle");
                if (conn != null)
                {
                    //先判断是否存在
                    string sql = " select * from OA_MJWXD where oaid='" + mj.oaid + "'";
                    OracleCommand cmd = new OracleCommand(sql, conn);
                    OracleDataAdapter da = new OracleDataAdapter(cmd);
                    DataTable dt = new DataTable();
                    da.Fill(dt);
                    var num = dt.Rows.Count;
                    ToolHelper.CloseSql(conn);
                    if (num == 0)
                    {
                        conn = ToolHelper.OpenRavoerp("oa");
                        sql = " SELECT * FROM V_MJWX where lcbh='" + mj.oaid + "'";
                        cmd = new OracleCommand(sql, conn);
                        da = new OracleDataAdapter(cmd);
                        dt = new DataTable();
                        da.Fill(dt);
                        string mjbh1 = dt.Rows[0]["mjbh1"].ToString();
                        string mjbh2 = dt.Rows[0]["mjbh2"].ToString();
                        string mjbh5 = dt.Rows[0]["mjbh5"].ToString();
                        string mjbh6 = dt.Rows[0]["mjbh6"].ToString();
                        string ly = dt.Rows[0]["LY"].ToString();
                        string cpwt = dt.Rows[0]["cpwt"].ToString();
                        string mjwt = dt.Rows[0]["mjwt"].ToString();
                        string zrhf = dt.Rows[0]["zrhf"].ToString();
                        string xmfa = dt.Rows[0]["xmfa"].ToString();
                        string sqr = dt.Rows[0]["sqr"].ToString();
                        string sqrq = dt.Rows[0]["sqrq"].ToString();
                        string yqwcsj = dt.Rows[0]["yqwcsj"].ToString();
                        string mjysr = dt.Rows[0]["mjysr"].ToString();
                        string mjysrq = dt.Rows[0]["mjysrq"].ToString();
                        string cpysr = dt.Rows[0]["cpysr"].ToString();
                        string cpysrq = dt.Rows[0]["cpysrq"].ToString();
                        ToolHelper.CloseSql(conn);
                        DateTime nowtime = DateTime.Now;
                        string ntime = Convert.ToString(nowtime);
                        if (mj.fb == "23")//工业
                        {
                            conn = ToolHelper.OpenRavoerp("middle");
                            sql = " INSERT INTO OA_MJWXD (OAID,FMOLDID,FCOMPANY,SOURCE,PRODUCT_PROBLEM,DUTY_ALLOCATION,REPAIR_BLUE_PRINT,APPLICANT,APPLICATION_DATE,NEED_TIME," +
                                "MOULD_CHECK_MAN,MOULD_CHECK_DATE,PRODUCT_CHECK_MAN,PRODUCT_CHECK_DATE,RECEIVING_TIME)" +
                                " VALUES ( '" + mj.oaid + "','" + mjbh2 + "','23','" + ly + "','" + cpwt + "','" + zrhf + "','" + xmfa + "','" + sqr + "',to_date('" + sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                "to_date('" + yqwcsj + "','yyyy-mm-dd hh24:mi:ss'),'" + mjysr + "',to_date('" + mjysrq + "','yyyy-mm-dd hh24:mi:ss'),'" + cpysr + "',to_date('" + cpysrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                " to_date('" + ntime + "','yyyy-mm-dd hh24:mi:ss'))";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            return "1";
                        }
                        else if (mj.fb == "21")//实业
                        {
                            conn = ToolHelper.OpenRavoerp("middle");
                            sql = " INSERT INTO OA_MJWXD (OAID,FMOLDID,FCOMPANY,SOURCE,PRODUCT_PROBLEM,DUTY_ALLOCATION,REPAIR_BLUE_PRINT,APPLICANT,APPLICATION_DATE,NEED_TIME," +
                                "MOULD_CHECK_MAN,MOULD_CHECK_DATE,PRODUCT_CHECK_MAN,PRODUCT_CHECK_DATE,RECEIVING_TIME)" +
                                " VALUES ( '" + mj.oaid + "','" + mjbh1 + "','21','" + ly + "','" + cpwt + "','" + zrhf + "','" + xmfa + "','" + sqr + "',to_date('" + sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                "to_date('" + yqwcsj + "','yyyy-mm-dd hh24:mi:ss'),'" + mjysr + "',to_date('" + mjysrq + "','yyyy-mm-dd hh24:mi:ss'),'" + cpysr + "',to_date('" + cpysrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                " to_date('" + ntime + "','yyyy-mm-dd hh24:mi:ss'))";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            return "1";
                        }
                        else if (mj.fb == "22")//隆威
                        {
                            conn = ToolHelper.OpenRavoerp("middle");
                            sql = " INSERT INTO OA_MJWXD (OAID,FMOLDID,FCOMPANY,SOURCE,PRODUCT_PROBLEM,DUTY_ALLOCATION,REPAIR_BLUE_PRINT,APPLICANT,APPLICATION_DATE,NEED_TIME," +
                                "MOULD_CHECK_MAN,MOULD_CHECK_DATE,PRODUCT_CHECK_MAN,PRODUCT_CHECK_DATE,RECEIVING_TIME)" +
                                " VALUES ( '" + mj.oaid + "','" + mjbh5 + "','22','" + ly + "','" + cpwt + "','" + zrhf + "','" + xmfa + "','" + sqr + "',to_date('" + sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                "to_date('" + yqwcsj + "','yyyy-mm-dd hh24:mi:ss'),'" + mjysr + "',to_date('" + mjysrq + "','yyyy-mm-dd hh24:mi:ss'),'" + cpysr + "',to_date('" + cpysrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                " to_date('" + ntime + "','yyyy-mm-dd hh24:mi:ss'))";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            return "1";
                        }
                        else if (mj.fb == "161")//研森
                        {
                            conn = ToolHelper.OpenRavoerp("middle");
                            sql = " INSERT INTO OA_MJWXD (OAID,FMOLDID,FCOMPANY,SOURCE,PRODUCT_PROBLEM,DUTY_ALLOCATION,REPAIR_BLUE_PRINT,APPLICANT,APPLICATION_DATE,NEED_TIME," +
                                "MOULD_CHECK_MAN,MOULD_CHECK_DATE,PRODUCT_CHECK_MAN,PRODUCT_CHECK_DATE,RECEIVING_TIME)" +
                                " VALUES ( '" + mj.oaid + "','" + mjbh6 + "','141','" + ly + "','" + cpwt + "','" + zrhf + "','" + xmfa + "','" + sqr + "',to_date('" + sqrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                "to_date('" + yqwcsj + "','yyyy-mm-dd hh24:mi:ss'),'" + mjysr + "',to_date('" + mjysrq + "','yyyy-mm-dd hh24:mi:ss'),'" + cpysr + "',to_date('" + cpysrq + "','yyyy-mm-dd hh24:mi:ss')," +
                                " to_date('" + ntime + "','yyyy-mm-dd hh24:mi:ss'))";
                            cmd = new OracleCommand(sql, conn);
                            int result = cmd.ExecuteNonQuery();
                            ToolHelper.CloseSql(conn);
                            return "1";
                        }
                        else
                        {
                            return "";
                        }
                    }

                }
                return "";
            }
            catch (Exception e)
            {
                return "";
            }
        }

    
 
    }
}
